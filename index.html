<!DOCTYPE html>
<html lang="pt-br">
<head>
    <title>Mapa RPG Interativo 8K</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
    /* --- ESTILOS GERAIS --- */
    
    /* Fundo Azul Escolhido (#4F686E) */
    body { margin: 0; background: #4F686E; overflow: hidden; font-family: sans-serif; }
    #map { height: 100vh; width: 100vw; z-index: 1; background: #4F686E; }

    /* MENU LATERAL (PRETO) */
    #menu-provincias {
        position: fixed;
        top: 20px; right: 20px;
        width: 220px;
        background: rgba(26, 26, 26, 0.95); 
        border: 2px solid #8b4513;
        border-radius: 8px;
        color: white;
        z-index: 2000;
        padding: 15px;
        box-shadow: 0 0 15px rgba(0,0,0,0.8);
        transition: 0.3s;
    }

    #menu-provincias h3 {
        text-align: center;
        margin-top: 0;
        color: #cd853f;
        border-bottom: 1px solid #555;
        padding-bottom: 10px;
        cursor: pointer;
    }

    /* Adicione isso dentro da tag <style> */
    .foto-lista { 
        width: 80px; height: 110px; 
        object-fit: cover; /* Isso impede a foto de ficar esticada/deformada */
        border: 1px solid #8b4513; 
        margin-right: 15px; 
        flex-shrink: 0; 
        background: #000;
    }

    /* Estilo para os links dentro do hist√≥rico */
    .link-historia {
        color: #ffd700; /* Amarelo Ouro */
        text-decoration: underline;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
    }
    .link-historia:hover {
        color: #fff; /* Fica branco ao passar o mouse */
        text-shadow: 0 0 5px #ffd700;
    }
    .texto-capitulo {
        font-size: 16px;
        line-height: 1.6;
        text-align: justify;
        white-space: pre-wrap; /* Mant√©m par√°grafos do texto */
    }

    #seta-menu { display: none; }
    #lista-botoes-provincia { display: block; }

/* --- ESTILO DOS BOT√ïES DOS POPUPS --- */
    .botao-estiloso {
        display: flex;
        align-items: center;
        width: 100%;
        margin-bottom: 6px;
        padding: 10px 12px;
        background: rgba(30, 30, 30, 0.95); 
        color: #e0e0e0;
        border: none;
        border-left: 4px solid #555; /* A cor muda no JS */
        text-align: left;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .botao-estiloso:hover {
        background: #444;
        padding-left: 18px; /* Efeito de deslize */
        color: #fff;
    }

    /* --- VOLTANDO O ESTILO ORIGINAL DO MENU --- */
    .botao-provincia {
        display: block; width: 100%;
        padding: 10px; margin: 5px 0;
        background: transparent; color: #ddd;
        border: 1px solid #444; border-radius: 4px;
        text-align: left; cursor: pointer;
        transition: 0.3s;
    }

    .botao-provincia:hover {
        background: #8b4513; color: white; border-color: #a0522d;
    }

    /* CONTAINER DA FOTO EST√ÅTICA */
    #provincia-container {
        display: none;
        background: #4F686E; 
        height: 100vh; width: 100vw; 
        position: fixed; top: 0; left: 0;
        z-index: 3000;
        flex-direction: column;
        align-items: center; justify-content: center;
    }

    #img-provincia {
        max-height: 85vh; max-width: 90vw;
        object-fit: contain;
        box-shadow: 0 0 50px rgba(0,0,0,1);
        border: 2px solid #333;
    }

    /* POPUPS E BOT√ïES */
    .leaflet-popup-content-wrapper { background: #2c2c2c; color: #fff; font-size: 14px; }
    .leaflet-popup-tip { background: #2c2c2c; }
    
    .btn-popup {
        background: #8b4513; color: white; border: none;
        padding: 8px 12px; border-radius: 3px;
        cursor: pointer; font-weight: bold;
    }

    /* MODAL DE DETALHES */
    #modal-info {
        position: fixed; z-index: 5000; left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
        display: flex; align-items: center; justify-content: center;
    }

    .modal-conteudo {
        background-color: #2c2c2c; border: 2px solid #cd853f;
        width: 60%; max-width: 800px; max-height: 80vh;
        overflow-y: auto; padding: 30px; border-radius: 10px;
        color: #ddd; font-family: serif; box-shadow: 0 0 20px #cd853f;
        position: relative;
    }
    .modal-conteudo h2 { color: #cd853f; border-bottom: 1px solid #555; padding-bottom: 10px; margin-top: 0; }
    .modal-conteudo p { line-height: 1.6; font-size: 18px; }
    .modal-conteudo strong { color: #ffdead; }
    .fechar-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }


    /* Estilo para a lista de boatos */
    .lista-boatos {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .boato-item {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #444;
        padding: 10px;
        border-radius: 5px;
        display: flex;
        align-items: flex-start;
    }
    .boato-numero {
        font-weight: bold;
        color: #cd853f;
        margin-right: 10px;
        min-width: 30px;
    }
    .boato-texto {
        font-style: italic;
        color: #aaa;
    }
    /* Estilo quando o boato √© descoberto */
    .boato-descoberto {
        border-color: #ffd700;
        background: rgba(139, 69, 19, 0.2);
    }
    .boato-descoberto .boato-texto {
        color: #ffdead;
        font-style: normal;
        font-weight: 500;
    }

    /* --- ESTILO BANCO --- */
    .tabela-banco { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    .tabela-banco th, .tabela-banco td { border: 1px solid #555; padding: 8px; text-align: left; color: #ddd; }
    .tabela-banco th { background-color: #3e2723; color: #ffdead; }
    .preco-banco { color: #ffd700; font-weight: bold; }
    .nota-banco { font-size: 12px; color: #aaa; margin-top: 10px; font-style: italic; }

    /* --- ESTILO DEUSES (ATUALIZADO) --- */
    .grid-deuses { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    
    .item-deus { 
        background: rgba(0,0,0,0.4); 
        border: 1px solid #444; 
        padding: 10px; 
        border-radius: 5px; 
        text-align: center; /* Centraliza tudo */
        cursor: pointer;    /* M√£ozinha de clique */
        transition: transform 0.2s, border-color 0.2s;
    }
    .item-deus:hover {
        transform: scale(1.02);
        border-color: #ffd700;
        background: rgba(255, 215, 0, 0.1);
    }

    /* Nova classe para a imagem do deus */
    .foto-deus-thumb {
        width: 100%;
        height: 100px;
        object-fit: cover; /* Corta a imagem pra caber sem esticar */
        border-radius: 4px;
        border: 1px solid #8b4513;
        margin-bottom: 5px;
    }

    .nome-deus { color: #87ceeb; font-weight: bold; font-size: 16px; display: block; margin-bottom: 3px; }
    .desc-deus { font-size: 13px; color: #ccc; display: block; }
    .dominio-deus { font-size: 11px; color: #aaa; text-transform: uppercase; margin-top: 5px; display: block; }

    /* --- AJUSTES PARA CELULAR --- */
    @media only screen and (max-width: 600px) {
        #menu-provincias {
            width: auto !important;
            right: 10px !important; top: 10px !important;
            padding: 10px; max-width: 70vw; 
        }
        #menu-provincias h3 { margin: 0; padding-bottom: 0; border-bottom: none; font-size: 14px; }
        #seta-menu { display: inline; margin-left: 5px; }
        #lista-botoes-provincia { 
            display: none; 
            margin-top: 10px; border-top: 1px solid #555; padding-top: 5px;
        }
        .modal-conteudo { width: 90% !important; padding: 15px !important; }
        #img-provincia { max-height: 70vh !important; max-width: 95vw !important; }
        
        /* Ajuste do bot√£o de voltar para ficar no topo, abaixo do zoom */
        .leaflet-control-button-voltar {
            margin-top: 10px !important; 
        }
    }
    /* --- NOVOS ESTILOS PARA O MENU DA CAPITAL --- */
    #modal-capital {
        position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center;
    }
    
    /* Estilo da lista de membros/procurados */
    .item-menu { 
        border-bottom: 1px solid #444; padding: 15px 0; display: flex; align-items: flex-start; 
    }
    .item-menu:last-child { border-bottom: none; }
    
    .foto-placeholder { 
        width: 80px; height: 110px; background: #3d3d3d; border: 1px solid #8b4513; 
        margin-right: 15px; flex-shrink: 0; display: flex; 
        align-items: center; justify-content: center; font-size: 10px; color: #777; 
    }
    
    .texto-item h4 { margin: 0 0 5px 0; color: #ffdead; font-size: 18px; }
    .texto-item p { font-size: 14px; margin: 0; color: #ccc; }
    .recompensa { color: #ffd700; font-weight: bold; display: block; margin-bottom: 5px; }
    .classe-char { color: #cd853f; font-weight: bold; font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 5px; }
    
/* --- ESTILO DA CALCULADORA --- */
    .tabela-viagem { width: 100%; border-collapse: collapse; margin-top: 10px; color: #ddd; }
    .tabela-viagem td, .tabela-viagem th { border: 1px solid #444; padding: 8px; text-align: left; }
    .tabela-viagem th { background: #2c3e50; color: #ffd700; }
    
    .modo-medicao-ativo {
        cursor: crosshair !important; /* Muda o mouse para uma cruz */
    }
    .destaque-gold { color: #ffd700; font-weight: bold; }
    .destaque-silver { color: #c0c0c0; font-weight: bold; }
    .destaque-bronze { color: #cd7f32; font-weight: bold; }

    /* Quando ativo, desabilita cliques nos marcadores existentes para permitir tra√ßar rota por cima */
    .mapa-intangivel .leaflet-marker-icon,
    .mapa-intangivel .leaflet-popup {
        pointer-events: none !important;
        opacity: 0.7; /* Fica meio transparente pra indicar que n√£o pode clicar */
    }
    
    /* Marcadores da pr√≥pria rota (bolinhas vermelhas) devem continuar vis√≠veis */
    .marcador-rota {
        pointer-events: none; /* Apenas visual */
    }

    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
    </div>

    <div id="modal-info" style="display: none;">
        <div class="modal-conteudo">
            <span class="fechar-modal" onclick="fecharModalInfo()">&times;</span>
            <h2 id="titulo-provincia">T√≠tulo</h2>
            <div id="texto-provincia"></div>
        </div>
    </div>
    <div id="modal-capital">
        <div class="modal-conteudo">
            <span class="fechar-modal" onclick="fecharModais()">&times;</span>
            <h2 id="titulo-menu-capital" style="color: #cd853f; border-bottom: 1px solid #555;">Capital</h2>
            <div id="conteudo-menu-capital">
                </div>
        </div>
    </div>

<div id="menu-provincias">
    <h3 onclick="alternarMenuMobile()">Menu Principal <span id="seta-menu">‚ñº</span></h3>
    <div id="lista-botoes-provincia">
        
        <div style="color: #cd853f; font-size: 12px; margin-bottom: 5px; text-align: center;">PROV√çNCIAS</div>

            <button class="botao-provincia" onclick="abrirMapaProvincia('Hukmal_tep.jpg')">‚ùÑÔ∏è Hukmal'tep</button>
            <button class="botao-provincia" onclick="abrirMapaProvincia('Blat_khyr.jpg')">üçÇ Blat'khyr</button>
            <button class="botao-provincia" onclick="abrirMapaProvincia('Deserto.jpg')">üèúÔ∏è Deserto</button>
            <button class="botao-provincia" onclick="abrirMapaProvincia('Lago.jpg')">‚õ©Ô∏è Lago</button>
            <button class="botao-provincia" onclick="abrirMapaProvincia('Alcova.jpg')">üè¥‚Äç‚ò†Ô∏è Alcova</button>
        
        <hr style="border: 0; border-top: 1px solid #555; margin: 10px 0;">
        
        <div style="color: #cd853f; font-size: 12px; margin-bottom: 5px; text-align: center;">COSMOLOGIA</div>
        <button class="botao-provincia" onclick="abrirModalSenha('portal', 'Planos.jpg', 'mapa')" style="color: #aeb6bf;">üåå Outros Planos</button>

        <hr style="border: 0; border-top: 1px solid #555; margin: 10px 0;">
        
        <div style="color: #cd853f; font-size: 12px; margin-bottom: 5px; text-align: center;">FERRAMENTAS</div>
        
        <button id="btn-coords-menu" class="botao-provincia" onclick="alternarCoordenadas()" style="color: #aaa;">üìç Coords: OFF</button>
        <button id="btn-medidor" class="botao-provincia" onclick="ativarMedidor()" style="color: #90EE90; border-color: #2E8B57;">üìè Calculadora de Viagem</button>

    </div>
</div>
    <div id="provincia-container">
        <img id="img-provincia" src="">
    </div>

<div id="modal-senha" style="display: none; position: fixed; z-index: 6000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center;">
        <div class="modal-conteudo" style="width: 400px; text-align: center;">
            <h3 style="color: #cd853f;">üîí √Årea Bloqueada</h3>
            <p>Qual a palavra de passe?</p>
            
            <input type="text" id="input-senha-rpg" placeholder="Digite a senha..." 
                   style="width: 80%; padding: 10px; margin-bottom: 20px; background: #222; border: 1px solid #8b4513; color: white; font-size: 16px; text-align: center;">
            
            <br>
            <button class="btn-popup" onclick="verificarSenha()" style="background: #2E8B57; font-size: 16px; margin-right: 10px;">üîì Tentar</button>
            <button class="btn-popup" onclick="fecharModalSenha()" style="background: #8b0000; font-size: 16px;">‚ùå Cancelar</button>
            
            <p id="msg-erro-senha" style="color: #ff4444; display: none; font-size: 14px; margin-top: 10px;">
                Senha incorreta. Por favor AGUARDE descobrirem a senha.
            </p>
        </div>
    </div>

<div id="modal-viagem" style="display: none; position: fixed; z-index: 6000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center;">
        <div class="modal-conteudo" style="max-width: 500px;">
            <span class="fechar-modal" onclick="document.getElementById('modal-viagem').style.display='none'">&times;</span>
            <h3 style="color: #90EE90;">üìä Relat√≥rio de Viagem</h3>
            <div id="resultado-viagem"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
// --- 1. CONFIGURA√á√ïES T√âCNICAS ---
    const configContinental = { arquivo: 'Mapa teste.png', largura: 7680, altura: 4320, minZoom: -2.0, maxZoom: 3 };
    const configProvincia = { largura: 2048, altura: 1536, minZoom: -1.0, maxZoom: 2 };
    
// --- VARI√ÅVEIS GLOBAIS ---
    let map; 
    let mapaAtualAtivo = 'continente';
    let planoSelecionado = null; 
    let modoCoordenadas = false;
    let fatorEscala = 0.23;

// Fun√ß√£o para gerar o HTML do bot√£o elegante
    function criarBtn(texto, acao, corBarra) {
        return `<button onclick="${acao}" class="botao-estiloso" style="border-left-color: ${corBarra};">${texto}</button>`;
    }

    // --- VARI√ÅVEIS DA CALCULADORA ---
    // AQUI ESTAVA O ERRO: Faltava criar o grupoRota
    const grupoRota = L.layerGroup(); 
    
    let medindo = false;
    let pontosRota = [];

    // --- FUN√á√ïES DE NAVEGA√á√ÉO E SISTEMA ---

// --- 2. INICIALIZA√á√ÉO DO MAPA (COM BOT√ÉO PERSISTENTE) ---
    function inicializarMapa(arquivo, largura, altura, minZoom, maxZoom) {
        if (map) { map.remove(); } 

        const limitesImagem = [[0, 0], [altura, largura]];
        const padding = 1500; 
        const limitesNavegacao = [[-padding, -padding], [altura + padding, largura + padding]];
        
        map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: minZoom,
            maxZoom: maxZoom,
            maxBounds: limitesNavegacao, 
            maxBoundsViscosity: 0.5,     
            tap: false,
            zoomControl: false // Opcional: Se quiser mover o zoom, avise
        });

        // Adiciona atalho de teclado para desfazer ponto (CTRL + Z)
    document.addEventListener("keydown", function(e) {
        if (medindo && e.ctrlKey && e.key === 'z') {
            desfazerUltimoPonto();
        }
    });

        grupoRota.addTo(map);
        // Adiciona o Zoom num lugar padr√£o (j√° que removemos acima para testar, se sumir o zoom apague a linha zoomControl: false)
        L.control.zoom({ position: 'topleft' }).addTo(map);

        L.imageOverlay(arquivo, limitesImagem).addTo(map);
        map.fitBounds(limitesImagem);
        
// --- 1. L√ìGICA DO CLIQUE (ATUALIZADA) ---
        map.on('click', function(e) {
            // Se o medidor estiver ligado, processa a viagem
            if (medindo) {
                processarCliqueMedicao(e.latlng);
                return; // Para por aqui
            }

            // Se o modo Coordenadas estiver ligado
            if (modoCoordenadas) {
                const y = e.latlng.lat.toFixed(0);
                const x = e.latlng.lng.toFixed(0);
                L.popup().setLatLng(e.latlng).setContent(`Coordenadas: [${y}, ${x}]`).openOn(map);
                console.log(`[${y}, ${x}]`); 
            }
        });

        // --- 2. BOT√ÉO FLUTUANTE NO MAPA ---
        const CoordsControl = L.Control.extend({
            options: { position: 'bottomright' }, // Canto inferior direito
            onAdd: function() {
                const btn = L.DomUtil.create('button', '');
                btn.id = 'btn-coords-mapa'; // ID para a gente achar ele depois
                btn.style.cssText = "padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:12px; margin-right: 10px; margin-bottom: 10px;";
                
                // Define a cor inicial baseada no estado atual
                atualizarVisualBotao(btn);

                btn.onclick = function(e) {
                    L.DomEvent.stopPropagation(e); // N√£o clica no mapa
                    alternarCoordenadas();
                };
                return btn;
            }
        });
        map.addControl(new CoordsControl());
    }

    // 2. Alterna menu no celular
    function alternarMenuMobile() {
        if (window.innerWidth > 600) return;
        const lista = document.getElementById('lista-botoes-provincia');
        const seta = document.getElementById('seta-menu');
        const estiloAtual = window.getComputedStyle(lista).display;
        if (estiloAtual === 'none') {
            lista.style.display = 'block';
            seta.innerHTML = '‚ñ≤';
        } else {
            lista.style.display = 'none';
            seta.innerHTML = '‚ñº';
        }
    }

// 3. Carrega o mapa principal (Continente)
    function carregarMapaPrincipal() {
        mapaAtualAtivo = 'continente';
        fatorEscala = 0.23; // Escala do continente
        planoSelecionado = null;

        // --- LIMPEZA DE ROTA (GARANTIA) ---
        if (medindo) cancelarModoMedicao();
        grupoRota.clearLayers();
        pontosRota = [];
        // ----------------------------------

        document.getElementById('map-container').style.display = 'block';
        document.getElementById('provincia-container').style.display = 'none';
        document.getElementById('menu-provincias').style.display = 'block';
        
        if (window.innerWidth <= 600) {
            document.getElementById('lista-botoes-provincia').style.display = 'none';
            document.getElementById('seta-menu').innerHTML = '‚ñº';
        } else {
            document.getElementById('lista-botoes-provincia').style.display = 'block';
        }

        inicializarMapa(configContinental.arquivo, configContinental.largura, configContinental.altura, configContinental.minZoom, configContinental.maxZoom);
        adicionarMarcadoresPrincipais();
    }

    // --- FUN√á√ïES DOS BOT√ïES EXTRAS (Agora fora de qualquer outra fun√ß√£o) ---

// --- SISTEMA DE SENHA (√öNICO E CORRIGIDO) ---
    let senhaCorretaAtual = "";
    let destinoAposSenha = ""; 
    let tipoAcaoSenha = "mapa"; 

    // 1. Abre o modal e configura o que vai acontecer
    function abrirModalSenha(senha, destino, tipo = 'mapa') {
        senhaCorretaAtual = senha;
        destinoAposSenha = destino;
        tipoAcaoSenha = tipo;
        
        const modal = document.getElementById('modal-senha');
        const input = document.getElementById('input-senha-rpg');
        const msg = document.getElementById('msg-erro-senha');

        // Limpa estados anteriores
        input.value = "";
        input.disabled = false;
        msg.style.display = 'none';
        modal.style.display = 'flex';
        
        // Foca no campo automaticamente
        setTimeout(() => input.focus(), 50); 
    }

    // 2. Verifica se a senha est√° certa
    function verificarSenha() {
        const input = document.getElementById('input-senha-rpg');
        const msg = document.getElementById('msg-erro-senha');
        
        // Compara ignorando mai√∫sculas/min√∫sculas
        if (input.value.toLowerCase() === senhaCorretaAtual.toLowerCase()) {
            // SUCESSO
            msg.style.display = 'block';
            msg.style.color = '#2ecc71'; 
            msg.innerHTML = "‚ú® Acesso concedido!";
            input.disabled = true;

            // Espera um pouco e executa a a√ß√£o (abrir mapa ou foto)
            setTimeout(() => {
                fecharModalSenha();
                input.disabled = false;
                
                if (tipoAcaoSenha === 'imagem') {
                    verImagemEstatica(destinoAposSenha);
                } else {
                    abrirMapaProvincia(destinoAposSenha);
                }
            }, 1200);

        } else {
            // ERRO (MENSAGEM QUE VOC√ä PEDIU)
            msg.style.display = 'block';
            msg.style.color = '#ff4444';
            msg.innerHTML = "Senha incorreta. Por favor AGUARDE descobrirem a senha.";
            
            // Efeito visual de erro no input
            input.style.borderColor = "red";
            setTimeout(() => input.style.borderColor = "#8b4513", 500);
            input.select(); 
        }
    }

    // 3. Fecha o modal
    function fecharModalSenha() {
        document.getElementById('modal-senha').style.display = 'none';
    }

    // 4. Atalho para o bot√£o ENTER
    const inputPass = document.getElementById('input-senha-rpg');
    if (inputPass) {
        inputPass.addEventListener("keypress", function(e) {
            if (e.key === "Enter") verificarSenha();
        });
    }
function alternarCoordenadas() {
        modoCoordenadas = !modoCoordenadas; // Inverte o valor
        
        // Atualiza o bot√£o do Menu Lateral (se existir)
        const btnMenu = document.getElementById('btn-coords-menu');
        atualizarVisualBotao(btnMenu);

        // Atualiza o bot√£o Flutuante do Mapa (se existir)
        const btnMapa = document.getElementById('btn-coords-mapa');
        atualizarVisualBotao(btnMapa);
    }

    // Fun√ß√£o auxiliar para mudar a cor dos bot√µes
    function atualizarVisualBotao(btn) {
        if (!btn) return;
        
        if (modoCoordenadas) {
            btn.innerHTML = "üìç Coords: ON";
            btn.style.background = "#27ae60"; 
            btn.style.color = "white";
            btn.style.border = "1px solid #2ecc71";
        } else {
            btn.innerHTML = "üìç Coords: OFF";
            btn.style.background = "rgba(0,0,0,0.7)"; 
            btn.style.color = "#aaa";
            btn.style.border = "1px solid #444";
        }
    }

    // ... (O resto do seu c√≥digo: dadosProvincias, dadosCapital, etc. continua igual abaixo)

    // --- 5. BANCO DE DADOS (TEXTOS COMPLETOS RESTAURADOS) ---

    const textosPlanos = {
        'divino': {
            titulo: "O Plano Divino",
            texto: "<p><strong>A Luz Eterna:</strong> Onde residem as divindades da ordem. O tempo √© um eterno 'agora'.</p><hr><p>1. Port√£o Dourado<br>2. Jardins El√≠sios<br>3. Trono de Cristal</p>"
        },
        'demoniaco': {
            titulo: "O Plano Demon√≠aco",
            texto: "<p><strong>O Abismo:</strong> Reino de caos e sofrimento.</p><hr><p>1. Lama de Sangue<br>2. Cidadela de Ferro<br>3. Po√ßo Sem Fundo</p>"
        },
        'espiritual': {
            titulo: "O Plano Espiritual",
            texto: "<p><strong>O Fluxo:</strong> O rio de mana e almas.</p><hr><p>1. O V√©u<br>2. Biblioteca dos Sonhos<br>3. Mar de Almas</p>"
        },
        'mortal': {
            titulo: "O Plano Mortal (Arton)",
            texto: "<p><strong>O Equil√≠brio:</strong> O mundo material onde a vida acontece.</p>"
        }
    };

    const dadosProvincias = {
        'Hukmal_tep.jpg': {
            titulo: "Hukmal'tep - O Inverno Absoluto",
            descricao: `
                <p><strong>üìú Panorama:</strong> Uma vastid√£o dominada por picos colossais e frio implac√°vel. O vento uiva incessantemente entre os vales profundos, moldando uma paisagem onde apenas os mais resilientes prosperam sob o manto de neve eterna.</p>
                <p><strong>üëë Governan√ßa:</strong> O poder √© partilhado pelo <em>Conselho das Tr√™s Tribos</em> (Felistas, Malistas e Garra do Inverno). N√£o existe um soberano √∫nico, mas sim uma tr√©gua armada e tensa entre os cl√£s.</p>
                <p><strong>üßë‚Äçü§ù‚Äçüßë Habitantes:</strong> Predominantemente composta por Humanos adaptados ao clima severo, An√µes das montanhas e Mesti√ßos que buscam ref√∫gio na isola√ß√£o.</p>
                <p><strong>‚öîÔ∏è Tradi√ß√µes:</strong> Uma cultura que exalta a for√ßa bruta e o instinto de sobreviv√™ncia. A magia √© encarada com profundo ceticismo e desconfian√ßa; estudiosos e acad√™micos s√£o raros e raramente bem-vindos.</p>
                <p><strong>üíé Subsist√™ncia:</strong> A economia gira em torno do com√©rcio de peles ex√≥ticas e subprodutos obtidos da ca√ßa de feras colossais que habitam a regi√£o.</p>
            `
        },
        'Blat_khyr.jpg': {
            titulo: "Blat'khyr - O Ber√ßo da Magia",
            descricao: `
                <p><strong>üìú Panorama:</strong> Um reino onde a realidade √© moldada pelo fluxo m√≠stico. A densidade de mana nesta prov√≠ncia √© t√£o alta que a pr√≥pria fauna e flora sofreram muta√ß√µes m√°gicas, criando cen√°rios de beleza surreal e perigo arcano.</p>
                <p><strong>üëë Governan√ßa:</strong> Embora exista uma linhagem real √©lfica cerimonial, a gest√£o administrativa e pol√≠tica reside nas m√£os do <em>Conselho √âlfico</em>, composto pelos mais experientes anci√£os da ra√ßa.</p>
                <p><strong>üßë‚Äçü§ù‚Äçüßë Habitantes:</strong> Uma popula√ß√£o majoritariamente de Elfos e Humanos com afinidade m√°gica.</p>
                <p><strong>‚öîÔ∏è Tradi√ß√µes:</strong> A sociedade valoriza o intelecto, a eleg√¢ncia est√©tica e a maestria arcana. Existe um forte sentimento de preserva√ß√£o cultural entre os Elfos, que muitas vezes evitam o contato pr√≥ximo com outras ra√ßas para preservar o seu "potencial m√≠stico".</p>
                <p><strong>üíé Subsist√™ncia:</strong> O epicentro do mercado arcano, focado na cria√ß√£o, encantamento e exporta√ß√£o de itens m√°gicos de alt√≠ssima qualidade.</p>
            `
        },
        'Deserto.jpg': {
            titulo: "O Deserto - A Origem do Mundo",
            descricao: `
                <p><strong>üìú Sociedade de Castas:</strong> Uma teocracia r√≠gida baseada no controle da √°gua. No topo est√£o os <strong>Zha-Ruk</strong> (Senhores da Nascente), seguidos pelos <strong>Atarim</strong> (Buscadores de Rel√≠quias) e os ricos <strong>Samum</strong> (Mercadores). A base √© formada pelos <strong>Ghovar</strong> (Trabalhadores) e, √† margem, os temidos <strong>Khali</strong> (Os "Secos" ou intoc√°veis).</p>
                <p><strong>üëë Governan√ßa:</strong> Cidades-estado controladas pelos Zha-Ruk, onde a lei √© ditada pela preserva√ß√£o h√≠drica. Desperdi√ßar √°gua √© punido com a morte ou ex√≠lio.</p>
                <p><strong>üßë‚Äçü§ù‚Äçüßë Ra√ßas Principais:</strong> Humanos, Meio-dem√¥nios, an√µes, mesti√ßos e seres adaptados ao calor extremo.</p>
                <p><strong>‚öîÔ∏è Tradi√ß√µes:</strong> Forte tradi√ß√£o oral e leis de hospitalidade r√≠gidas. As ru√≠nas antigas s√£o consideradas sagradas e perigosas, acess√≠veis apenas aos autorizados.</p>
                <p><strong>üíé Economia:</strong> Extra√ß√£o de especiarias raras, min√©rios e venda de rel√≠quias da "Primeira Era" encontradas nas escava√ß√µes.</p>
            `
        },
        'Lago.jpg': {
            titulo: "O Lago - O Solo Aben√ßoado",
            descricao: `
                <p><strong>üìú Panorama:</strong> Uma regi√£o de serenidade contemplativa, onde a honra se reflete nas √°guas cristalinas do lago sagrado. A arquitetura √© integrada √† natureza, utilizando madeira e pedra em designs orientais cl√°ssicos.</p>
                <p><strong>üëë Governan√ßa:</strong> Uma oligarquia de disnastias que comandam as terras e que governam sob um r√≠gido c√≥digo de honra e lealdade ao trono imperial.</p>
                <p><strong>üßë‚Äçü§ù‚Äçüßë Habitantes:</strong> Humanos e Mesti√ßos.</p>
                <p><strong>‚öîÔ∏è Tradi√ß√µes:</strong> Os costumes s√£o profundamente orientais, valorizando o respeito aos ancestrais, a cerim√¥nia do ch√° e a disciplina das artes marciais e caligrafia. A harmonia e o equil√≠brio espiritual s√£o os pilares da sociedade.</p>
                <p><strong>üíé Subsist√™ncia:</strong> O celeiro do imp√©rio; produz gr√£os finos, seda de alta qualidade e pescados raros encontrados apenas nas profundezas do lago.</p>
            `
        },
        'Alcova.jpg': {
            titulo: "Alcova - O Lar dos Piratas",
            descricao: `
                <p><strong>üìú Descri√ß√£o:</strong> Um arquip√©lago repleto de ba√≠as escondidas, cavernas marinhas e rotas de navega√ß√£o perigosas.</p>
                <p><strong>üëë Governo:</strong> Uma "Confedera√ß√£o Livre" onde a lei √© ditada por quem possui o navio mais r√°pido ou os canh√µes mais fortes.</p>
                <p><strong>üßë‚Äçü§ù‚Äçüßë Ra√ßas Principais:</strong> Uma mistura ca√≥tica de todas as ra√ßas, principalmente aquelas fugindo da lei imperial.</p>
                <p><strong>‚öîÔ∏è Cultura:</strong> Liberdade individual extrema e um c√≥digo de honra duvidoso entre capit√£es.</p>
                <p><strong>üíé Economia:</strong> Pirataria, mercado negro e transporte de mercadorias ex√≥ticas "n√£o taxadas".</p>
            `
        },
        'Espinha do Gigante.jpg': {
            titulo: "Regi√£o Desconhecida",
            descricao: "<p>N√£o h√° registros detalhados sobre esta √°rea nos arquivos imperiais.</p>"
        },

    'Mar.jpg': {
        titulo: "O Mar Profundo",
        descricao: "<p><strong>üåä Descri√ß√£o:</strong> Uma vastid√£o azul e perigosa, acess√≠vel apenas para aqueles que conhecem os segredos das mar√©s.</p>"
    }, 
'Planos.jpg': {
        titulo: "A Grande Roda Cosmol√≥gica",
        descricao: `
            <p><strong>üåå O Nexus:</strong> O ponto de converg√™ncia absoluto entre todas as realidades. √â daqui que as almas partem para seus destinos finais ou retornam para suas origens.</p>
            <p>Este √© o centro da exist√™ncia, onde os v√©us entre os mundos s√£o mais finos e a pr√≥pria realidade parece vibrar com a energia dos portais.</p>
        `
    },
    'Plano Espiritual.png': {
        titulo: "üçÉ O Plano Espiritual",
        descricao: `
            <p><strong>Lei do Mundo:</strong> O tempo aqui √© uma ilus√£o; dias podem passar como segundos. A pr√≥pria ess√™ncia do plano √© inebriante, e viajantes devem testar sua vontade constantemente, pois o desejo de permanecer para sempre √© uma armadilha doce e perigosa.</p>
            <hr>
            <p><strong>1¬∫ Andar: √âden</strong><br>Um para√≠so de luz eterna onde a noite nunca cai. Habitado por fadas e esp√≠ritos elementais, oferece frutas e conforto em abund√¢ncia. √â a distra√ß√£o perfeita para quem esquece seu prop√≥sito.</p>
            <p><strong>2¬∫ Andar: Naitim√©re</strong><br>O reflexo sombrio. Um reino de noite perp√©tua que distorce a realidade para manifestar seus pesadelos mais profundos. A sanidade √© o recurso mais escasso aqui.</p>
            <p><strong>3¬∫ Andar: Animalia</strong><br>Lar de Bestas Primordiais dotadas de fala e intelecto. A regra da ca√ßa √© brutal: "aquele que tira uma vida, assume sua forma", transformando ca√ßadores em presas.</p>
            <p><strong>4¬∫ Andar: Fungi</strong><br>Uma floresta alien√≠gena de cogumelos colossais. Esporos flutuam no ar com efeitos que variam da cura milagrosa √† alucina√ß√£o mortal. √â o territ√≥rio de gigantes silenciosos.</p>
            <p><strong>5¬∫ Andar: O Vegetal</strong><br>O cora√ß√£o verde onde Ents e Dr√≠ades guardam a vida. A flora √© t√£o vibrante que consome a carne; visitantes sentem sua pele enrijecer e folhas brotarem se ficarem tempo demais.</p>
            <p><strong>6¬∫ Andar: Draconfelt</strong><br>O ber√ßo dos Drag√µes. Uma terra de biomas extremos e majestosos. A grandiosidade do ambiente cobra um pre√ßo, drenando lentamente a energia vital daqueles que n√£o pertencem a este lugar.</p>
        `
    },
    'Plano Divino.png': {
        titulo: "‚òÄÔ∏è O Plano Divino",
        descricao: `
            <p><strong>Lei do Mundo:</strong> Um santu√°rio de pureza absoluta. Maldi√ß√µes s√£o anuladas instantaneamente e poderes das trevas definham. Os Anjos, guardi√µes deste reino, s√£o incapazes de mentir, embora sejam mestres na arte da verdade incompleta.</p>
            <hr>
            <p><strong>1¬∫ Andar: Olimpo</strong><br>O cume da cria√ß√£o. Morada exclusiva das divindades maiores. O ar vibra com poder divino e a entrada √© restrita apenas aos pr√≥prios deuses ou convidados de honra excepcional.</p>
            <p><strong>2¬∫ Andar: Angeheim</strong><br>A Cidadela da Verdade. A atmosfera imp√µe uma press√£o f√≠sica sobre a falsidade; √© imposs√≠vel proferir uma mentira enquanto se respira o ar deste lugar.</p>
            <p><strong>3¬∫ Andar: Sovengarde</strong><br>O eterno campo de batalha. O destino daqueles que ca√≠ram bravamente em combate. Aqui, ferimentos mortais cicatrizam ao amanhecer, permitindo que a gl√≥ria da luta recomece.</p>
            <p><strong>4¬∫ Andar: R√©vem</strong><br>O descanso final das almas benevolentes. A paz √© t√£o absoluta que se torna perigosa: a bondade do ambiente for√ßa uma purifica√ß√£o espiritual, podendo apagar a personalidade original do visitante.</p>
            <p><strong>5¬∫ Andar: Cosmos</strong><br>O vazio iluminado. O lar das Estrelas e entidades c√≥smicas. Caminhar por aqui √© tocar o tecido do universo, e os dignos podem receber b√™n√ß√£os estelares.</p>
        `
    },
    'Plano Demon√≠aco.png': {
        titulo: "üî• O Plano Demon√≠aco",
        descricao: `
            <p><strong>Lei do Mundo:</strong> Um abismo que fortalece a magia negra e as artes profanas. A atmosfera √© t√≥xica para a alma; a exposi√ß√£o prolongada convida maldi√ß√µes terr√≠veis a se instalarem no corpo do viajante.</p>
            <hr>
            <p><strong>1¬∫ Andar: O Abismo</strong><br>Um labirinto de crep√∫sculo eterno e n√©voa densa. As luzes brilham com metade da for√ßa e as sombras parecem ter vida pr√≥pria. Perder o caminho aqui √© fatalmente f√°cil.</p>
            <p><strong>2¬∫ Andar: Gehenna</strong><br>O Deserto da Desola√ß√£o. Dunas infinitas feitas das cinzas de almas. O vento drena a energia f√≠sica e mental, levando os viajantes √† exaust√£o e √† depress√£o profunda.</p>
            <p><strong>3¬∫ Andar: O C√°rcere</strong><br>A pris√£o eterna de rocha e ferro est√©ril. Magias de transporte e comunica√ß√£o s√£o anuladas. √â um lugar de sil√™ncio, repleto de armadilhas para garantir que nada escape.</p>
            <p><strong>4¬∫ Andar: Inferno</strong><br>O epicentro da dor, cortado por rios de lava e sangue. A maldade do ambiente √© contagiosa, tentando ativamente corromper o cora√ß√£o dos visitantes e torn√°-los naquilo que desprezam.</p>
            <p><strong>5¬∫ Andar: Diabolos</strong><br>O Ninho. Uma rede claustrof√≥bica de t√∫neis org√¢nicos e f√©tidos. A exposi√ß√£o prolongada inicia uma metamorfose grotesca, transformando o vivo em mais uma larva da colmeia.</p>
        `
    },
    // ... outros mapas
        'default': { 
            titulo: "Regi√£o Desconhecida", 
            descricao: "<p>N√£o h√° registros detalhados sobre esta √°rea nos arquivos imperiais.</p>" 
            
        }
    };

// --- DADOS DA CAPITAL (COM FOTOS) ---
// 1. Cria 100 boatos vazios automaticamente
    const listaBoatos = Array.from({ length: 100 }, (_, i) => ({
        id: i + 1,
        texto: "Boato ainda n√£o ouvido...",
        descoberto: false
    }));

    // 2. Define o Boato 100 (O √∫nico conhecido agora)
    // Nota: Como array come√ßa no 0, o boato 100 fica na posi√ß√£o 99
    listaBoatos[99] = {
        id: 100,
        texto: "Dizem que existe um 101¬∫ boato que revela o segredo para se tornar um deus, mas ningu√©m nunca o ouviu. E dizem que tudo o que voc√™ ouviu at√© agora pode ser uma mentira inventada para te manter longe da verdade.",
        descoberto: true
    };

    // --- DADOS GERAIS (BANCO E DEUSES) ---
    const dadosGerais = {
        banco: [
            { nome: "Pacote Econ√¥mico", custo: "2 Golds", desc: "Poder enterrar em um canto e o gerente finge que n√£o viu." },
            { nome: "Pacote Iniciante", custo: "5 Golds", desc: "Guarda at√© 50 golds e 1 item." },
            { nome: "Pacote Intermedi√°rio", custo: "15 Golds", desc: "Guarda 150g, 1 armadura, 1 arma, 3 itens. (Acesso transporte imperial)" },
            { nome: "Pacote Avan√ßado", custo: "35 Golds", desc: "Seguro de vida, 300g, 2 armaduras, 4 armas, 6 itens, 1 criatura. (Acesso transporte)" },
            { nome: "Pacote Arranjado", custo: "A Definir", desc: "Negociado diretamente com o contratante." },
            { nome: "Pacote VIP", custo: "Exclusivo", desc: "Guarda de objeto/criatura com avalia√ß√£o personalizada." }
        ],
        investimentos: [
            { nome: "Tesouro Imperial", risco: "Baixo Risco", min: "5g" },
            { nome: "A√ß√µes do Imp√©rio", risco: "Alto Risco", min: "5g" }
        ],
// Dentro de const dadosGerais = { ...
    
deuses: [
        { nome: "Pelor", titulo: "Sol, Luz e Fogo", raca: "Anjos", foto: "Pelor.png" },
        { nome: "Aqua", titulo: "√Ågua e Serenidade", raca: "Halflings", foto: "Aqua.png" },
        { nome: "Celeste", titulo: "Espa√ßo", raca: "Estrelas", foto: "Celeste.png" },
        { nome: "Luna", titulo: "Lua e Trevas", raca: "Dem√¥nios", foto: "Luna.png" },
        { nome: "Laphiaferd", titulo: "Magia", raca: "Esp√≠ritos", foto: "Laphiaferd.png" },
        { nome: "H√∫ngaro", titulo: "Tempo", raca: "Humanos", foto: "H√∫ngaro.png" },
        { nome: "Terraria", titulo: "Terra e Lealdade", raca: "An√µes", foto: "Terraria.png" },
        { nome: "Astronof", titulo: "Ar e Conhecimento", raca: "Machinas", foto: "Astronof.png" },
        { nome: "Golias (PVP)", titulo: "Guerra", raca: "Gigantes", foto: "Golias (PvP).png" },
        { nome: "Dentos", titulo: "Gan√¢ncia", raca: "Orcs e Trolls", foto: "Dentos.png" },
        { nome: "Lusit√¢nia", titulo: "Plantas", raca: "Elfos", foto: "Lusit√¢nia.png" },
        { nome: "Ruegra", titulo: "Animais", raca: "Mesti√ßos", foto: "Ruegra.png" }
    ]
};

    const dadosCapital = {
        esquadrao: [
            // Coloque o nome EXATO do arquivo da imagem que est√° na pasta
            { 
                nome: "Lythael Serind√´", 
                classe: "Curandeira", 
                raca: "Elfa alta",
                foto: "Lythael.png",  // <--- AQUI VAI O ARQUIVO DA FOTO
                desc: "Uma guardi√£ serena e observadora, cuja gentileza externa esconde uma for√ßa inabal√°vel dedicada a proteger e valorizar toda forma de vida.om uma espada longa." 
            },
            { 
                nome: "Valkia Huniman", 
                raca: "Meio Anja",
                classe: "Guerreira", 
                foto: "Valkia.png",     // <--- AQUI VAI O ARQUIVO DA FOTO
                desc: "Embora aparente seriedade inicial, logo revela uma natureza vibrante e impetuosa, movida pelo desejo de provar sua evolu√ß√£o enquanto exalta constantemente os nomes de Ryuiki e Daruin." 
            },
                        { 
                nome: "Greta Thunder", 
                raca: "Elfa da Floresta",
                classe: "Maga", 
                foto: "Greta.jpg",     // <--- AQUI VAI O ARQUIVO DA FOTO
                desc: "Uma guardi√£ solit√°ria de Desterroth que nutre profundo desprezo pela humanidade e outras ra√ßas, confiando apenas na justi√ßa da natureza e em seus cactos; agora, ela √© for√ßada a agir contra uma corrup√ß√£o obscura que amea√ßa a floresta que jurou proteger." 
            },
                        { 
                nome: "Balon Blacktide", 
                raca: "Meio Dem√¥nio",
                classe: "Ca√ßador", 
                foto: "Balon.jpg",     // <--- AQUI VAI O ARQUIVO DA FOTO
                desc: "Das li√ß√µes da nobreza aos naufr√°gios da pirataria, este meio-dem√¥nio de poucas palavras carrega no sobrenome a marca de sua sobreviv√™ncia e, na alma, o conflito eterno entre o sangue amaldi√ßoado e a luz que busca gui√°-lo." 
            },
                        { 
                nome: "Thorga Punho de Ferro", 
                raca: "An√£o",
                classe: "Guerreiro", 
                foto: "Thorga.jpg",     // <--- AQUI VAI O ARQUIVO DA FOTO
                desc: "Exilado injustamente das forjas ancestrais, Thorgar √© um mercen√°rio impetuoso que rejeita a autoridade de reis e deuses, lutando pela pura emo√ß√£o da batalha e para provar que sua for√ßa basta por si s√≥." 
            },
                        { 
                nome: "Li√©sty", 
                raca: "Elfa Negra",
                classe: "Maga", 
                foto: "Li√©sty.jpg",     // <--- AQUI VAI O ARQUIVO DA FOTO
                desc: "Sobrevivente solit√°ria de uma destrui√ß√£o brutal, esta elfa negra trocou a companhia dos vivos pelo sil√™ncio de sua cabana na floresta, onde sua natureza sombria e suas artes arcanas servem como barreira contra um mundo que ela aprendeu a desprezar." 
            }
        ],
        procurados: [
            { 
                nome: "Kalamar", 
                recompensa: "1.800 Moedas de Ouro", 
                foto: "Kalamar.png",   // <--- AQUI VAI O ARQUIVO DA FOTO
                desc: "Vivo ou morto. Lenda dos mares que trocou a gl√≥ria da aventura pelo submundo. Comanda uma frota colossal que espalha terror pelos oceanos, traficando de rel√≠quias a vidas sem distin√ß√£o." 
            },
            { 
                nome: "Bruiser", 
                recompensa: "1.200 Moedas de Ouro", 
                foto: "Bruiser.png",        // Se n√£o tiver foto, coloque null ou apague a linha foto
                desc: "Vivo ou morto. Um mago renegado cuja sede de conhecimento ultrapassou a moralidade. Procurado por conduzir experimentos grotescos e ilegais em seres vivos, distorcendo a natureza em busca de poder." 
            },
            { 
                nome: "Leimo", 
                recompensa: "1.500 Moedas de Ouro", 
                foto: "Leimo.png",           // Se n√£o tiver foto, coloque null ou apague a linha foto
                desc: "Morto. Ex-membro da Torre dos S√°bios. Sua genialidade tornou-se arrog√¢ncia; ele se rebelou por acreditar ser uma divindade entre mortais, usando segredos arcanos para cometer crimes contra o Imp√©rio." 
            },
            { 
                nome: "O Palha√ßo", 
                recompensa: "10.000 Moedas de Ouro", 
                foto: "Palha√ßo.png",          // Se n√£o tiver foto, coloque null ou apague a linha foto
                desc: "Vivo. Um agente do caos que semeia disc√≥rdia por puro entretenimento. Suspeito de conspirar com for√ßas das trevas, ele manipula reinos para incitar guerras, rindo enquanto o mundo queima." 
            },
            { 
                nome: "Fanastia", 
                recompensa: "700 Moedas de Ouro", 
                foto: "Fanastia.png",           // Se n√£o tiver foto, coloque null ou apague a linha foto
                desc: "Vivo ou morto. Uma vampira ancestral com um rastro de sangue que atravessa s√©culos. Respons√°vel pelo massacre de mais de mil almas, ela v√™ a humanidade apenas como alimento para saciar sua sede eterna." 
            },
            { 
                nome: "Mari, a Psicopata", 
                recompensa: "500 Moedas de Ouro", 
                foto: "Mari.png",           // Se n√£o tiver foto, coloque null ou apague a linha foto
                desc: "Morto. Uma for√ßa de destrui√ß√£o imprevis√≠vel e sem remorso. N√£o possui agenda pol√≠tica ou m√°gica; mata por impulso e loucura, deixando um rastro de terror por onde passa." 
            },
            { 
                nome: "Leoncio", 
                recompensa: "2.000 Moedas", 
                foto: "Leoncio.png",           // Se n√£o tiver foto, coloque null ou apague a linha foto
                desc: "Morto. Antigo instrutor de elite do Imp√©rio, agora seu maior traidor. Conhece todas as t√°ticas militares de seus ex-aliados, usando esse conhecimento para desestabilizar a na√ß√£o que jurou defender." 
            },
            { 
                nome: "Drai", 
                recompensa: "2.000 Moedas", 
                foto: "Drai.png",           // Se n√£o tiver foto, coloque null ou apague a linha foto
                desc: "Morto. Feiticeira xen√≥foba obcecada pelos esp√≠ritos da floresta. V√™ outras ra√ßas como pragas e executa assassinatos em massa para 'purificar' a natureza, servindo a uma vis√£o distorcida do equil√≠brio." 
            }
        ],
        
        // --- NOVO: HIST√ìRICO ---
        historico: [
            {
                titulo: "Cap√≠tulo 0: O Chamado",
                texto: `
                A jornada come√ßou com um sonho misterioso, onde o <span class="link-historia" onclick="verImagemHistoria('Serafim.png', 0)">Serafim da Ordem</span> revelou o retorno de uma for√ßa de destrui√ß√£o. Em troca de salvarem o mundo, ele prometeu realizar seus desejos e os guiou at√© a <span class="link-historia" onclick="verImagemHistoria('Capital.png', 0)">Capital Imperial</span>.
                
                L√°, o grupo se alistou no ex√©rcito com a ajuda do amig√°vel <span class="link-historia" onclick="verImagemHistoria('Will.png', 0)">Will</span> e adotou o nome "Os Pandem√¥nios". Para provar seu valor, enfrentaram os testes rigorosos da Comandante <span class="link-historia" onclick="verImagemHistoria('Valentina.png', 0)">Valentina</span>, que inclu√≠ram enigmas e uma batalha brutal contra um <span class="link-historia" onclick="verImagemHistoria('Gorila.png', 0)">Gorila</span> feroz.
                
                Na primeira miss√£o, sob a supervis√£o da arrogante Mestra <span class="link-historia" onclick="verImagemHistoria('Carla.png', 0)">Carla</span>, foram capturados pelo infame Capit√£o <span class="link-historia" onclick="verImagemHistoria('Kalamar.png', 0)">Kalamar</span>. Amea√ßados, tiveram que explorar uma masmorra antiga repleta de enigmas e tecnologia esquecida.
                
                O cl√≠max foi o confronto contra um <span class="link-historia" onclick="verImagemHistoria('Kraken.png', 0)">Kraken</span> colossal. Ap√≥s derrotarem a besta e recuperarem uma b√∫ssola m√°gica, a ilha foi destru√≠da, e o grupo escapou por pouco gra√ßas √† interven√ß√£o her√≥ica de Will.`
            },
            {
                titulo: "Cap√≠tulo 1: Desconhecido",
                texto: `Aventura em progresso...`
            },
            {
                titulo: "Cap√≠tulo 2: Desconhecido",
                texto: `Aventura em progresso...`
            },
            {
                titulo: "Cap√≠tulo 3: Desconhecido",
                texto: `Aventura em progresso...`
            },
            {
                titulo: "Cap√≠tulo 4: Desconhecido",
                texto: `Aventura em progresso...`
            }
        ],
// ... dentro de dadosCapital ...
        bestiario: [
            { 
                nome: "Gorila Gliador", 
                perigo: "üíÄ", 
                fraqueza: "N√£o h√°", 
                drops: "Pele de gorila", 
                foto: "Gorila.png", // Coloque a foto se tiver
                desc: "Uma besta territorial encontrada nas selvas do Coliseu. Usado para testar a for√ßa de gladiadores."
            },
            { 
                nome: "Kraken", 
                perigo: "üíÄüíÄüíÄüíÄüíÄüíÄ", 
                fraqueza: "Pedra gigante do Will", 
                drops: "Tinta M√≠stica, Tent√°culo Gigante", 
                foto: "Kraken.png", 
                desc: "O terror dos mares. Foi derrotado, mas boatos dizem que era apenas um filhote."
            },
            { 
                nome: "Murloc", 
                perigo: "üíÄ", 
                fraqueza: "Fogo, Ataques f√≠sicos, Gente inteligente", 
                drops: "Armas simples", 
                foto: "murloc.png", 
                desc: "Ca√ßam em bandos, gostam de lugares √∫midos e fechados"
            }
        ], 
        // ... dentro de dadosCapital ...
        
        lendas: [
            { 
                nome: "A Bruxa", 
                titulo: "A Guardi√£ Eterna", 
                desc: "Protetora dos segredos arcanos. Sua vigil√¢ncia constante impede que for√ßas m√≠sticas ameacem o equil√≠brio do mundo." 
            },
            { 
                nome: "O Palha√ßo", 
                titulo: "O Agente do Destino", 
                desc: "Com t√°ticas imprevis√≠veis, desestabilizou as fileiras inimigas, trazendo a vit√≥ria atrav√©s da genialidade n√£o convencional." 
            },
            { 
                nome: "A Prod√≠gio", 
                titulo: "A Arquiteta do Amanh√£", 
                desc: "Mente brilhante que forjou as defesas do reino, provando que a engenhosidade humana pode alcan√ßar o divino." 
            },
            { 
                nome: "O Druida", 
                titulo: "A Voz da Terra", 
                desc: "Aquele que uniu a f√∫ria da natureza √† causa dos mortais, garantindo que o mundo lutasse ao nosso lado." 
            },
            { 
                nome: "A Santa", 
                titulo: "A Luz da Esperan√ßa", 
                desc: "Sua f√© inabal√°vel foi o escudo que protegeu as almas inocentes durante as eras mais sombrias." 
            },
            { 
                nome: "O Her√≥i", 
                titulo: "O Escudo da Honra", 
                desc: "O l√≠der inquebr√°vel, cujo c√≥digo moral e bravura inspiraram ex√©rcitos inteiros a nunca recuar." 
            },
            { 
                nome: "O S√°bio", 
                titulo: "O Olho da Verdade", 
                desc: "Detentor do conhecimento supremo, cujas estrat√©gias foram tra√ßadas com uma sabedoria al√©m da compreens√£o mortal." 
            },
            { 
                nome: "A Vidente", 
                titulo: "A Tecel√£ do Tempo", 
                desc: "Guiou o grupo atrav√©s das infinitas possibilidades, garantindo o √∫nico futuro onde a luz prevaleceria." 
            },
            { 
                nome: "A Feiticeira", 
                titulo: "O Avatar do Poder", 
                desc: "Uma for√ßa da natureza em forma humana, cuja magia devastadora foi a espada que quebrou as defesas demon√≠acas." 
            },
            { 
                nome: "O Espadachim", 
                titulo: "A L√¢mina Perfeita", 
                desc: "O guerreiro definitivo, cuja maestria marcial transcendeu os limites f√≠sicos para derrotar o mal." 
            },
            { 
                nome: "O Bardo", 
                titulo: "A Alma do Mundo", 
                desc: "Suas can√ß√µes n√£o apenas registraram a hist√≥ria, mas acenderam a chama da coragem nos cora√ß√µes desesperados." 
            },
            { 
                nome: "O Invocador", 
                titulo: "O Mestre dos Planos", 
                desc: "Convocou aliados de dimens√µes distantes, unindo universos diferentes em prol da salva√ß√£o de Tarre." 
            }
        ],

        boatos: listaBoatos 

        
    };

// --- FUN√á√ÉO MENU CAPITAL (ATUALIZADA) ---
    function menuCapital(tipo) {
        const modal = document.getElementById('modal-capital');
        const container = document.getElementById('conteudo-menu-capital');
        const titulo = document.getElementById('titulo-menu-capital');
        modal.style.display = 'flex';
        container.innerHTML = "";

        // --- ABA OS 12 LEND√ÅRIOS (TEXTO PURO) ---
        if (tipo === 'lendas') {
            titulo.innerText = "üèõÔ∏è Os 12 Her√≥is Lend√°rios";
            
            container.innerHTML += `<p style="font-style:italic; color:#aaa; font-size:14px; text-align:center; margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:10px;">"Aqueles que derrotaram o Primeiro Rei Dem√¥nio e forjaram a Era da Paz."</p>`;

            dadosCapital.lendas.forEach(heroi => {
                container.innerHTML += `
                    <div class="item-menu">
                        <div class="texto-item" style="width: 100%;">
                            <h4 style="color:#ffd700; margin-bottom: 2px;">${heroi.nome}</h4>
                            <span style="font-size:12px; font-weight:bold; color:#cd853f; text-transform:uppercase;">${heroi.titulo}</span>
                            <p style="margin-top:5px; font-size:13px; color:#ccc;">${heroi.desc}</p>
                        </div>
                    </div>`;
            });
            return;
        }

        // --- ABA BANCO ---
        if (tipo === 'banco') {
            titulo.innerText = "üè¶ Banco Imperial";
            let html = `<h4 style="color:#ffdead; margin-top:0;">Pacotes de Servi√ßos</h4>`;
            html += `<table class="tabela-banco"><tr><th>Pacote</th><th>Custo</th><th>Benef√≠cios</th></tr>`;
            dadosGerais.banco.forEach(item => {
                html += `<tr><td>${item.nome}</td><td class="preco-banco">${item.custo}</td><td>${item.desc}</td></tr>`;
            });
            html += `</table>`;
            html += `<h4 style="color:#ffdead; margin-top:20px;">Investimentos</h4><ul style="color:#ccc; padding-left:20px;">`;
            dadosGerais.investimentos.forEach(inv => {
                html += `<li><strong>${inv.nome}:</strong> ${inv.risco} (M√≠nimo ${inv.min})</li>`;
            });
            html += `</ul><div class="nota-banco">* Garantia total sobre bens guardados.<br>* N√£o existe upgrade de pacote (pre√ßo integral na troca).</div>`;
            container.innerHTML = html;
            return;
        }

        // --- ABA BOATOS ---
        if (tipo === 'boatos') {
            titulo.innerText = "üó£Ô∏è Boatos da Capital (1/100)";
            let html = `<div class="lista-boatos">`;
            dadosCapital.boatos.forEach(boato => {
                const classeExtra = boato.descoberto ? 'boato-descoberto' : '';
                const textoFinal = boato.descoberto ? boato.texto : "??????????????????";
                html += `<div class="boato-item ${classeExtra}"><span class="boato-numero">#${boato.id}</span><span class="boato-texto">"${textoFinal}"</span></div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
            return;
        }

        // --- ABA HIST√ìRICO ---
        if (tipo === 'historico') {
            titulo.innerText = "üìú Hist√≥rico de Aventuras";
            dadosCapital.historico.forEach((cap, index) => {
                container.innerHTML += `
                    <div class="item-menu" onclick="lerCapitulo(${index})" style="cursor: pointer; align-items: center;">
                        <div class="foto-placeholder" style="width: 50px; height: 50px; font-size: 20px;">üìñ</div>
                        <div class="texto-item"><h4 style="margin-top: 10px;">${cap.titulo}</h4><p style="font-size: 12px; color: #aaa;">Clique para ler</p></div>
                    </div>`;
            });
            return;
        }

        // --- ABA BESTI√ÅRIO ---
        if (tipo === 'bestiario') {
            titulo.innerText = "üìñ Besti√°rio Conhecido";
            dadosCapital.bestiario.forEach(monstro => {
                let img = monstro.foto 
                    ? `<img src="${monstro.foto}" class="foto-lista" onclick="verImagemPersonagem('${monstro.foto}')" style="cursor: zoom-in;" title="Clique para ampliar">` 
                    : `<div class="foto-placeholder">?</div>`;
                container.innerHTML += `
                    <div class="item-menu">${img}<div class="texto-item">
                        <h4 style="color:#ff4444;">${monstro.nome}</h4>
                        <span style="font-size:12px;">Perigo: ${monstro.perigo}</span><br>
                        <span style="font-size:12px; color:#aaa;">Fraqueza: ${monstro.fraqueza}</span>
                        <p style="font-style:italic; margin-top:5px;">"${monstro.desc}"</p>
                        <div style="margin-top:5px; font-size:11px; color:#ffd700;">Drop: ${monstro.drops}</div>
                    </div></div>`;
            });
            return;
        }

        // --- ABA ESQUADR√ÉO E PROCURADOS (PADR√ÉO) ---
        const lista = (tipo === 'esquadrao') ? dadosCapital.esquadrao : dadosCapital.procurados;
        titulo.innerText = (tipo === 'esquadrao') ? "üõ°Ô∏è Os Pandem√¥nios" : "‚ò†Ô∏è Cartazes de Procurados";
        lista.forEach(item => {
            let htmlImagem = item.foto 
                ? `<img src="${item.foto}" class="foto-lista" onclick="verImagemPersonagem('${item.foto}')" style="cursor: zoom-in;" title="Clique para ampliar">` 
                : `<div class="foto-placeholder">${tipo === 'esquadrao' ? 'RETRATO' : 'WANTED'}</div>`;
            let htmlSubtitulo = (tipo === 'esquadrao')
                ? `<span class="classe-char">${item.classe} ‚Ä¢ ${item.raca || 'Desconhecido'}</span>`
                : `<span class="recompensa">üí∞ ${item.recompensa}</span>`;
            container.innerHTML += `<div class="item-menu">${htmlImagem}<div class="texto-item"><h4>${item.nome}</h4>${htmlSubtitulo}<p>${item.desc}</p></div></div>`;
        });
    }

// --- FUN√á√ÉO: MENU DO PANTE√ÉO (ATUALIZADA) ---
    function menuDeuses() {
        const modal = document.getElementById('modal-capital');
        const container = document.getElementById('conteudo-menu-capital');
        const titulo = document.getElementById('titulo-menu-capital');
        modal.style.display = 'flex';
        
        titulo.innerText = "‚ö° Pante√£o dos 12 Deuses";
        let html = `<div class="grid-deuses">`;
        
        dadosGerais.deuses.forEach(deus => {
            // Se tiver foto, usa ela. Se n√£o, usa um placeholder cinza.
            const htmlImagem = deus.foto 
                ? `<img src="${deus.foto}" class="foto-deus-thumb">`
                : `<div class="foto-deus-thumb" style="background:#333; display:flex; align-items:center; justify-content:center;">?</div>`;

            // Adiciona o onclick enviando o arquivo da foto
            html += `
                <div class="item-deus" onclick="verImagemDeus('${deus.foto}')">
                    ${htmlImagem}
                    <span class="nome-deus">${deus.nome}</span>
                    <span class="desc-deus">${deus.titulo}</span>
                    <span class="dominio-deus">${deus.raca}</span>
                </div>`;
        });
        
        html += `</div>`;
        container.innerHTML = html;
    }

    // --- NOVA: LER O CAP√çTULO ---
    function lerCapitulo(index) {
        const container = document.getElementById('conteudo-menu-capital');
        const cap = dadosCapital.historico[index];
        
        // Bot√£o de Voltar para a lista de cap√≠tulos
        let html = `<button onclick="menuCapital('historico')" class="btn-popup" style="margin-bottom: 15px; background: #444;">‚¨Ö Voltar √† Lista</button>`;
        
        html += `<h3 style="color: #ffdead; border-bottom: 1px dashed #555; padding-bottom: 10px;">${cap.titulo}</h3>`;
        html += `<div class="texto-capitulo">${cap.texto}</div>`;
        
        container.innerHTML = html;
    }

// --- FUN√á√ÉO PARA VER IMAGEM DOS DEUSES ---
    function verImagemDeus(arquivo) {
        if (!arquivo) return; // Se n√£o tiver foto, n√£o faz nada

        // Esconde tudo
        document.getElementById('modal-capital').style.display = 'none';
        document.getElementById('map-container').style.display = 'none';
        document.getElementById('menu-provincias').style.display = 'none';

        // Prepara visualiza√ß√£o
        const containerImg = document.getElementById('provincia-container');
        containerImg.style.display = 'flex'; 
        document.getElementById('img-provincia').src = arquivo;

        // Bot√£o voltar ESPEC√çFICO para o menu de Deuses
        const btnVoltar = document.createElement('button');
        btnVoltar.innerHTML = "‚¨Ö Voltar ao Pante√£o";
        btnVoltar.className = "btn-popup";
        btnVoltar.style.cssText = "position: absolute; top: 20px; left: 20px; font-size: 16px; z-index: 4000; padding: 10px 20px;";
        
        btnVoltar.onclick = function() {
            containerImg.style.display = 'none';
            document.getElementById('map-container').style.display = 'block';
            
            // Restaura menu lateral se estiver no continente
            if (mapaAtualAtivo === 'continente') {
                document.getElementById('menu-provincias').style.display = 'block';
            }

            // Reabre o modal j√° carregando os deuses
            document.getElementById('modal-capital').style.display = 'flex';
            menuDeuses(); 
        };

        const btnAntigo = containerImg.querySelector('button');
        if (btnAntigo) containerImg.removeChild(btnAntigo);
        containerImg.insertBefore(btnVoltar, containerImg.firstChild);
    }

// --- FUN√á√ÉO PARA VER IMAGEM NO HIST√ìRICO (CORRIGIDA) ---
    function verImagemHistoria(arquivo, capituloIndex) {
        document.getElementById('modal-capital').style.display = 'none';
        document.getElementById('map-container').style.display = 'none';
        document.getElementById('menu-provincias').style.display = 'none'; // Esconde menu

        const containerImg = document.getElementById('provincia-container');
        containerImg.style.display = 'flex'; 
        document.getElementById('img-provincia').src = arquivo;

        const btnVoltar = document.createElement('button');
        btnVoltar.innerHTML = "‚¨Ö Voltar ao Texto";
        btnVoltar.className = "btn-popup";
        btnVoltar.style.cssText = "position: absolute; top: 20px; left: 20px; font-size: 16px; z-index: 4000; padding: 10px 20px;";
        
        btnVoltar.onclick = function() {
            containerImg.style.display = 'none';
            document.getElementById('map-container').style.display = 'block';
            
            // --- CORRE√á√ÉO: Restaura o menu se estiver no continente ---
            if (mapaAtualAtivo === 'continente') {
                document.getElementById('menu-provincias').style.display = 'block';
            }

            document.getElementById('modal-capital').style.display = 'flex';
            lerCapitulo(capituloIndex);
        };

        const btnAntigo = containerImg.querySelector('button');
        if (btnAntigo) containerImg.removeChild(btnAntigo);
        containerImg.insertBefore(btnVoltar, containerImg.firstChild);
    }

    // --- NOVA FUN√á√ÉO PARA AMPLIAR FOTO DO PERSONAGEM ---
// --- FUN√á√ÉO PARA AMPLIAR FOTO DO PERSONAGEM (CORRIGIDA) ---
    function verImagemPersonagem(arquivo) {
        document.getElementById('modal-capital').style.display = 'none';
        document.getElementById('map-container').style.display = 'none';
        document.getElementById('menu-provincias').style.display = 'none'; // Esconde menu

        const containerImg = document.getElementById('provincia-container');
        containerImg.style.display = 'flex'; 
        document.getElementById('img-provincia').src = arquivo;

        const btnVoltar = document.createElement('button');
        btnVoltar.innerHTML = "‚¨Ö Voltar ao Menu";
        btnVoltar.className = "btn-popup";
        btnVoltar.style.cssText = "position: absolute; top: 20px; left: 20px; font-size: 16px; z-index: 4000; padding: 10px 20px;";
        
        btnVoltar.onclick = function() {
            containerImg.style.display = 'none';
            document.getElementById('map-container').style.display = 'block';
            
            // --- CORRE√á√ÉO: Restaura o menu se estiver no continente ---
            if (mapaAtualAtivo === 'continente') {
                document.getElementById('menu-provincias').style.display = 'block';
            }

            document.getElementById('modal-capital').style.display = 'flex';
        };

        const btnAntigo = containerImg.querySelector('button');
        if (btnAntigo) containerImg.removeChild(btnAntigo);
        containerImg.insertBefore(btnVoltar, containerImg.firstChild);
    }
    // Nova fun√ß√£o que apenas fecha a foto sem resetar o mapa
    function fecharImagem() {
        document.getElementById('provincia-container').style.display = 'none';
        document.getElementById('map-container').style.display = 'block';
        
        // Se estiver no continente, garante que o menu aparece. 
        // Se estiver em prov√≠ncia, o menu continua escondido (como deve ser).
        if (mapaAtualAtivo === 'continente') {
            document.getElementById('menu-provincias').style.display = 'block';
        }
    }

    function fecharModais() { 
        document.getElementById('modal-info').style.display = 'none';
        document.getElementById('modal-capital').style.display = 'none';
    }
    
    // TRUQUE: Isso garante que se o HTML chamar 'fecharModalInfo', ele usa a nova fun√ß√£o
    window.fecharModalInfo = fecharModais;

// --- VARI√ÅVEL DE CONTROLE ---
    let selecaoAtual = null; // Guarda qual plano foi clicado por √∫ltimo

    // --- FUN√á√ÉO DE DETALHES (INTELIGENTE) ---
    function abrirModalInfo() {
        let dados;

        // 1. Se estiver no mapa dos Planos E tiver clicado em um marcador (Divino, Mortal, etc)
        if (mapaAtualAtivo === 'Planos.jpg' && selecaoAtual) {
            dados = textosPlanos[selecaoAtual]; 
        } 
        // 2. Se estiver no mapa dos Planos mas n√£o clicou em nada (Mostra resumo geral)
        else if (mapaAtualAtivo === 'Planos.jpg') {
            dados = dadosProvincias['Planos.jpg'];
        }
        // 3. Comportamento padr√£o para os outros mapas (Hukmal'tep, Deserto, etc)
        else {
            dados = dadosProvincias[mapaAtualAtivo] || dadosProvincias['default'];
        }

        // Abre o modal com os dados certos
        if (dados) {
            document.getElementById('titulo-provincia').innerHTML = dados.titulo;
            document.getElementById('texto-provincia').innerHTML = dados.texto || dados.descricao;
            document.getElementById('modal-info').style.display = 'flex';
        }
    }


// --- CONFIGURA√á√ïES DE TAMANHO ---
    // 1. O Mapa Geral dos Planos (O Nexus)
    const configPlanos = { largura: 741, altura: 1024, minZoom: -1.0, maxZoom: 3 }; 
    
    // 2. Os Mapas Individuais (Divino, Demon√≠aco, Espiritual)
    const configSubPlanos = { largura: 1024, altura: 1536, minZoom: -1.0, maxZoom: 3 }; 

function abrirMapaProvincia(arquivo) {
        mapaAtualAtivo = arquivo;
        
        // --- LIMPEZA DE ROTA (ISSO ESTAVA FALTANDO) ---
        if (medindo) cancelarModoMedicao();
        grupoRota.clearLayers();
        pontosRota = [];
        // ----------------------------------------------

        // --- L√ìGICA DE ESCALA ---
        if (arquivo.includes('Planos.jpg')) { 
             fatorEscala = 0.5; 
        } else if (arquivo.includes('Plano')) { 
             fatorEscala = 0.5;
        } else {
             fatorEscala = 0.13; // Escala regional
        }

        document.getElementById('menu-provincias').style.display = 'none';
        document.getElementById('map-container').style.display = 'block';
        document.getElementById('provincia-container').style.display = 'none';

        // L√ìGICA INTELIGENTE DE TAMANHO
        let cfg = configProvincia; 
        
        if (arquivo === 'Planos.jpg') {
            cfg = configPlanos; 
        } 
        else if (arquivo.includes('Plano') && arquivo !== 'Planos.jpg') {
            cfg = configSubPlanos; 
        }

        inicializarMapa(arquivo, cfg.largura, cfg.altura, cfg.minZoom, cfg.maxZoom);

        // --- BOT√ïES DE CONTROLE DO MAPA ---

        // 1. Bot√£o Voltar (Topo Esquerdo)
        const BotaoVoltarControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function() {
                const btn = L.DomUtil.create('button', 'leaflet-control-button-voltar');
                btn.innerHTML = "‚¨Ö Voltar ao Continente";
                
                if (arquivo.includes('Plano') && arquivo !== 'Planos.jpg') {
                    btn.innerHTML = "‚¨Ö Voltar ao Nexus";
                    btn.onclick = function(e) {
                        L.DomEvent.stopPropagation(e);
                        abrirMapaProvincia('Planos.jpg'); 
                    };
                } else {
                    btn.onclick = function(e) {
                        L.DomEvent.stopPropagation(e);
                        carregarMapaPrincipal(); 
                    };
                }
                
                btn.style.cssText = "white-space:nowrap; padding:12px 18px; background:#8b4513; color:white; border:2px solid #5e2f0d; border-radius:5px; cursor:pointer; font-weight:bold; font-size:14px; z-index:9999;";
                return btn;
            }
        });
        map.addControl(new BotaoVoltarControl());

        // 2. Bot√£o Detalhes (Topo Direito)
        const BotaoInfoControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function() {
                const btn = L.DomUtil.create('button', '');
                btn.innerHTML = "üìú Detalhes";
                btn.style.cssText = "white-space:nowrap; padding:10px 15px; background:#2c3e50; color:#cd853f; border:2px solid #cd853f; border-radius:5px; cursor:pointer; font-weight:bold;";
                btn.onclick = abrirModalInfo;
                return btn;
            }
        });
        map.addControl(new BotaoInfoControl());

        // 3. Bot√£o Calculadora Flutuante (Topo Direito - Abaixo)
        const BotaoMedirControl = L.Control.extend({
            options: { position: 'topright' }, 
            onAdd: function() {
                const btn = L.DomUtil.create('button', '');
                btn.id = 'btn-medidor-mapa'; 
                btn.innerHTML = "üìè Medir";
                btn.style.cssText = "white-space:nowrap; padding:8px 12px; background:rgba(0,0,0,0.8); color:#90EE90; border:1px solid #2E8B57; border-radius:5px; cursor:pointer; font-weight:bold; font-size:14px; margin-top: 5px;";
                btn.onclick = function(e) {
                    L.DomEvent.stopPropagation(e);
                    ativarMedidor();
                };
                return btn;
            }
        });
        map.addControl(new BotaoMedirControl());

        adicionarMarcadoresLocais(arquivo);
    }

function verImagemEstatica(arquivo) {
        // Esconde o mapa (mas ele continua vivo no fundo)
        document.getElementById('map-container').style.display = 'none';
        document.getElementById('menu-provincias').style.display = 'none'; // Esconde menu pra n√£o atrapalhar a foto
        document.getElementById('provincia-container').style.display = 'flex'; 
        document.getElementById('img-provincia').src = arquivo;
        
        const btnVoltarImg = document.createElement('button');
        btnVoltarImg.innerHTML = "‚¨Ö Voltar";
        btnVoltarImg.className = "btn-popup";
        // Ajustado para o topo
        btnVoltarImg.style.cssText = "position: absolute; top: 20px; left: 20px; font-size: 16px; z-index: 4000; padding: 10px 20px;";
        
        // AQUI EST√Å A MUDAN√áA M√ÅGICA:
        btnVoltarImg.onclick = fecharImagem; 
        
        const container = document.getElementById('provincia-container');
        const btnAntigo = container.querySelector('button');
        if (btnAntigo) container.removeChild(btnAntigo);
        container.insertBefore(btnVoltarImg, container.firstChild);
    }

 // --- 6. MARCADORES LOCAIS (FUN√á√ÉO COMPLETA ATUALIZADA) ---
function adicionarMarcadoresLocais(nomeDoMapa) {
    // √çcones padr√£o
    const iconP = L.icon({iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [50, 50], iconAnchor: [25, 25], popupAnchor: [0, -25]});
    const iconG = L.icon({iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [100, 100], iconAnchor: [50, 50], popupAnchor: [0, -50]});

    // --- FUN√á√ÉO INTERNA PADR√ÉO (Para mapas normais) ---
function criarPontoLocal(coord, nome, info, foto = null, grande = false, botaoExtra = null) {
        const m = L.marker(coord, {icon: grande ? iconG : iconP, opacity: 0}).addTo(map);
        let htmlBotoes = `<div style="margin-top: 8px; display:flex; flex-direction:column;">`;
        
        if (foto) htmlBotoes += criarBtn("üì∏ Ver Foto", `verImagemEstatica('${foto}')`, "#5F9EA0");
        if (botaoExtra) htmlBotoes += botaoExtra; // Mant√©m bot√µes manuais como Escola de Magia
        
        htmlBotoes += `</div>`;
        m.bindPopup(`<div style="text-align:center;"><b>${nome}</b><br><small style="color:#ccc;">${info}</small>${htmlBotoes}</div>`);
    }

        if (nomeDoMapa === 'Hukmal_tep.jpg') {
            criarPontoLocal([1396, 780], "Capital de Hukmal'tep", "Felista", "C√≥pia de capital de hukmal_tep.png", true);
            criarPontoLocal([1422, 441], "Torre de Vigia", "Felista");
            criarPontoLocal([1209, 520], "Torre de Vigia", "Felista");
            criarPontoLocal([1488, 1081], "Torre de Vigia", "Felista");
            criarPontoLocal([1222, 1158], "Torre de Vigia", "Felista");
            criarPontoLocal([1474, 546], "Porto", "Felista");
            criarPontoLocal([1256, 1129], "Vilarejo", "Felista");
            criarPontoLocal([1106, 505], "Vilarejo", "Felista");
            criarPontoLocal([157, 267], "Cidade", "Garra do Inverno");
            criarPontoLocal([419, 483], "Vilarejo", "Garra do Inverno");
            criarPontoLocal([242, 1338], "Vilarejo", "Garra do Inverno", "C√≥pia de cidade ponte.png", true);
            criarPontoLocal([369, 868], "Vilarejo", "Garra do inverno", "C√≥pia de Cidade neve 3.png", true);
            criarPontoLocal([268, 1472], "Torre de Vigia", "Malista");
            criarPontoLocal([513, 1617], "Cidade", "Malista", "C√≥pia de Cidade neve 5.png", true);
            criarPontoLocal([534, 1918], "Vilarejo", "Malista");
            criarPontoLocal([530, 1710], "Porto", "Malista");
            criarPontoLocal([678, 101], "Porto", "Malista");
            criarPontoLocal([707, 1520], "Vilarejo", "Malista");
            criarPontoLocal([659, 1127], "Vilarejo", "Malista", "C√≥pia de Cidade neve 4.png", true);
            criarPontoLocal([796, 1134], "Torre de Vigia", "Malista");
            criarPontoLocal([960, 1733], "Torre de Vigia", "Malista");
            criarPontoLocal([1113, 1460], "Vilarejo", "Malista");
            criarPontoLocal([1003, 172], "Vilarejo", "Malista");
            criarPontoLocal([673, 640], "Vilarejo", "Malista", "C√≥pia de cidade drag√£o.png", true);
            criarPontoLocal([621, 358], "Torre de Vigia", "Malista");
            criarPontoLocal([740, 452], "Torre de Vigia", "Malista");
            criarPontoLocal([713, 257], "Cidade Malista", "Malista", "C√≥pia de Cidade portuaria gelo.png", true);
            criarPontoLocal([141, 578], "Vilarejo", "Neutro", "inicial.png", true);
            criarPontoLocal([1184, 1014], "Vilarejo", "Neutro");
        }

        if (nomeDoMapa === 'Blat_khyr.jpg') {
            // --- PONTO DA ESCOLA DE MAGIA (J√Å EXISTIA) ---
            const btnEscola = criarBtn("üéì Escola de Magia", "abrirModalSenha('poder', 'bloqueado.jpg', 'imagem')", "#800080");
            criarPontoLocal([382, 1359], "Capital de Blat'khyr", "Elfos", "cidade magica.png", true, btnEscola);
            
            // --- OUTROS PONTOS ---
            criarPontoLocal([986, 1239], "Vilarejo", "Desconhecido");
            criarPontoLocal([1091, 606], "Vilarejo", "Desconhecido");

            // --- NOVO: PONTO DAS BRUXAS [1463, 1151] ---
            // 1. Cria o bot√£o com a senha "Bruxas" que abre a imagem "Vila bruxa.png"
            const btnBruxas = criarBtn("üîç Descobrir", "abrirModalSenha('Bruxas', 'Vila bruxa.png', 'imagem')", "#2E8B57");
            
            // 2. Cria o ponto passando o bot√£o
            criarPontoLocal([1463, 1151], "Vilarejo", "Desconhecido", null, true, btnBruxas);

            // --- RESTANTE DOS PONTOS DE BLAT'KHYR ---
            criarPontoLocal([491, 371], "Cidade", "Elfos", "Cidade portu√°ria 4.png", true);
            criarPontoLocal([741, 963], "Cidade", "Elfos", "Cidade portu√°ria.png", true);
            criarPontoLocal([621, 1760], "Cidade", "Elfos", "Cidade portu√°ria 2.png", true);
            criarPontoLocal([69, 1054], "Cidade", "Elfos", "Cidade portu√°ria 3.png", true);
            criarPontoLocal([408, 745], "Cidade", "Elfos", "Cidade portu√°ria 5.webp", true);
            criarPontoLocal([252, 891], "Cidade", "Elfos", "Cidade portu√°ria 6.jpg", true);
            criarPontoLocal([611, 1210], "Vilarejo", "Humanos", "Vila.png", true);
            criarPontoLocal([530, 1149], "Vilarejo", "Humanos");
            criarPontoLocal([556, 850], "Vilarejo", "Humanos");
            criarPontoLocal([641, 641], "Vilarejo", "Humanos");
            criarPontoLocal([256, 1302], "Vilarejo", "Humanos");
            criarPontoLocal([500, 1644], "Vilarejo", "Humanos");
            criarPontoLocal([273, 1366], "Cidade", "Elfos");
            criarPontoLocal([824, 894], "Muralha", "Elfos");
            criarPontoLocal([791, 648], "Muralha", "Elfos");
            criarPontoLocal([766, 388], "Muralha", "Elfos");
            criarPontoLocal([884, 1094], "Muralha", "Elfos");
            criarPontoLocal([882, 1271], "Muralha", "Elfos");
        }
         if (nomeDoMapa === 'Deserto.jpg') {
            criarPontoLocal([240, 762], "Capital do Deserto", "Zha-Ruk", "Capital deserto.png", true);
            criarPontoLocal([1314, 588], "Vilarejo", "Ghovar", "Vila deserto.png", true);
            criarPontoLocal([1422, 1582], "Vilarejo", "Ghovar", "Vila de areia.png", true);
            criarPontoLocal( [1256, 126], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [1436, 112], "Minera√ß√£o", "Abandonada");
            criarPontoLocal( [1362, 400], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [1247, 730], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [1213, 846], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [1256, 126], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [1408, 1727], "Minera√ß√£o", "Abandonada");
            criarPontoLocal( [1363, 1855], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [1217, 1298], "Minera√ß√£o", "Abandonada");
            criarPontoLocal( [1149, 1784], "Minera√ß√£o", "Abandonada");
            criarPontoLocal(  [1049, 1809], "Minera√ß√£o", "Abandonada");
            criarPontoLocal( [1142, 1921], "Minera√ß√£o", "Abandonada");
            criarPontoLocal( [693, 1510], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [871, 1533], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [786, 1775], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [1032, 365], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [990, 617], "Minera√ß√£o", "Ghovar");
            criarPontoLocal(  [808, 580], "Minera√ß√£o", "Ghovar");
            criarPontoLocal(  [813, 399], "Minera√ß√£o", "Ghovar");
            criarPontoLocal( [475, 566], "Minera√ß√£o", "Abandonada");
            criarPontoLocal( [326, 539], "Minera√ß√£o", "Abandonada");
            criarPontoLocal( [401, 376], "Minera√ß√£o", "Ghovar");
        
            criarPontoLocal([1082, 1619], "Cidade", "Samum", "Cidade an√£.png", true);
            criarPontoLocal([1434, 312], "Cidade", "Samum", "Cidade deserto.png", true);
            criarPontoLocal([1082, 146], "Cidade", "Samum", "Cidade deserto 2.png", true);
            criarPontoLocal( [752, 536], "Cidade", "Samum", "Cidade enterrada 2.png", true);
            criarPontoLocal( [148, 170], "Cidade", "Samum");
            criarPontoLocal( [188, 1910], "Cidade", "Samum");

            criarPontoLocal( [1394, 814], "Ru√≠nas", "Atarim", "Entrada deserto.png", true);
            criarPontoLocal( [920, 662], "Ru√≠nas", "Atarim", "paisagem.png", true);
            criarPontoLocal( [660, 1652], "Ru√≠nas", "Atarim");
            criarPontoLocal(  [1310, 1502], "Ru√≠nas", "Atarim");

            criarPontoLocal( [792, 912], "Castelo", "Zha-Ruk", "Castelo deserto 1.png", true);
            criarPontoLocal( [1394, 915], "Castelo", "Zha-Ruk", "Castelo deserto 2.png", true);
            criarPontoLocal( [332, 1278], "Castelo", "Zha-Ruk");
            criarPontoLocal( [1020, 1188], "Castelo", "Zha-Ruk");
            criarPontoLocal( [1210, 1118], "Torre de Vigia", "Zha-Ruk");
            criarPontoLocal(  [1432, 1196], "Torre de Vigia", "Zha-Ruk");

        }
         if (nomeDoMapa === 'Lago.jpg') {
            criarPontoLocal([970, 1152], "Templo do Lago", "Guardi√µes do Templo", "Templo do lago.png", true);
            const btnPanteao = criarBtn("‚ö° Pante√£o", "menuDeuses()", "#4682B4");
            criarPontoLocal([1366, 1578], "Cidade Sagrada", "Igreja dos 12 Deuses", "Cidade Santa.png", true, btnPanteao);
            criarPontoLocal([1336, 1740], "Cidade Sagrada", "Igreja dos 12 Deuses", "Cidade Santa.png", true, btnPanteao);
            criarPontoLocal([446, 1336], "Vilarejo", "Dinastia Xogum");
            const btnNinja = criarBtn("üîç Descobrir", "abrirModalSenha('ninja', 'bloqueado.jpg', 'imagem')", "#2E8B57");
            criarPontoLocal([180, 912], "Cidade", "Dinastia Xogum", "cidade lago 1.png", true, btnNinja);
            criarPontoLocal([898, 1908], "Cidade", "Dinastia Kemono", "capital do lago.png", true); 
            criarPontoLocal([726, 1366], "Cidade", "Dinastia Kemono", "cidade lago 2.png", true); //imagem beira do lago
            criarPontoLocal([948, 1672], "Vilarejo", "Dinastia Kemono");
            criarPontoLocal([980, 818], "Cidade", "Dinastia Kitsune", "cidade na montanha.png", true); //imagem beira do lago
            criarPontoLocal([1014, 92], "Vilarejo", "Dinastia Kitsune", "vilarejo na montanha.png", true);
            criarPontoLocal( [610, 706], "Vilarejo", "Dinastia Kitsune");
            criarPontoLocal( [1190, 532], "Vilarejo", "Dinastia Kitsune", "templo.png", true);
            criarPontoLocal( [1400, 192], "Vilarejo", "Dinastia Kitsune");
            criarPontoLocal( [1370, 1016], "Vilarejo", "Dinastia Kitsune");
            criarPontoLocal( [534, 400], "Vilarejo", "Dinastia Seilor");
            criarPontoLocal( [786, 460], "Cidade", "Dinastia Seilor", "cidade lago 3.png", true); //imagem com porto

 
        }

         if (nomeDoMapa === 'Alcova.jpg') {
            criarPontoLocal( [1326, 782], "Torre de Vigia", "Marinha Imperial");
            criarPontoLocal( [1175, 1185], "Torre de Vigia", "Marinha Imperial");
            criarPontoLocal( [1228, 1740], "Torre de Vigia", "Marinha Imperial");
            criarPontoLocal( [724, 650], "Torre de Vigia", "Marinha Imperial");
            criarPontoLocal( [850, 1007], "Torre de Vigia", "Marinha Imperial");
            criarPontoLocal(  [835, 1426], "Torre de Vigia", "Marinha Imperial");
            criarPontoLocal(  [778, 1526], "Torre de Vigia", "Marinha Imperial");

            criarPontoLocal(  [1333, 845], "Cidade", "Desconhecido");
            criarPontoLocal(  [1178, 1137], "Cidade", "Desconhecido");
            criarPontoLocal(  [1191, 1770], "Cidade", "Desconhecido");
            criarPontoLocal(  [637, 1817], "Cidade", "Desconhecido");
            criarPontoLocal(   [565, 1781], "Cidade", "Desconhecido");
            criarPontoLocal(  [814, 1010], "Cidade", "Desconhecido");
            criarPontoLocal(   [775, 643], "Cidade", "Desconhecido");
            criarPontoLocal(   [693, 612], "Cidade", "Desconhecido");
            criarPontoLocal(  [570, 285], "Cidade", "Desconhecido");
            criarPontoLocal(   [210, 344], "Cidade", "Desconhecido");
            criarPontoLocal(  [344, 1175], "Cidade", "Desconhecido");
            criarPontoLocal(   [1133, 536], "Cidade", "Desconhecido");
            criarPontoLocal(    [994, 437], "Cidade", "Desconhecido");

            criarPontoLocal( [904, 269], "Cidade", "Desconhecido", "Cidade pirata.png", true);
            criarPontoLocal(  [333, 1571], "Cidade", "Desconhecido");
            criarPontoLocal( [291, 1628], "Cidade", "Desconhecido");
            criarPontoLocal( [1311, 391], "Cidade", "Desconhecido", "Cidade alcova.jpg", true);
            const btnDescobrir = criarBtn("üîç Descobrir", "abrirModalSenha('mar', 'Mar.jpg')", "#2E8B57");
            criarPontoLocal([1052, 540], "Cidade", "Desconhecido", "Alcova.png", true, btnDescobrir);
            criarPontoLocal( [1131, 688], "Cidade", "Desconhecido", "Alcova 2.png", true);
            criarPontoLocal( [1189, 1455], "Cidade", "Desconhecido", "Alcova 3.png", true);
            criarPontoLocal( [1317, 1679], "Cidade", "Desconhecido");
            criarPontoLocal( [370, 736], "Cidade", "Desconhecido"); 
            criarPontoLocal(  [482, 1192], "Ilha dos Afogados", "Desconhecido", "lugar no mar.png", true);
            criarPontoLocal( [778, 1442], "Ilha Naval", "Marinha Imperial", "ilha naval.png", true);
            criarPontoLocal( [866, 1518], "Ilha Naval", "Marinha Imperial", "ilha naval.png", true);
            criarPontoLocal( [134, 1355], "Templo do Fim do Mundo", "Desconhecido", "Templo do fim do mundo.png", true);
          
 
        }
if (nomeDoMapa === 'Mar.jpg') {

            const btnSubir = criarBtn("‚¨ÜÔ∏è Subir", "abrirMapaProvincia('Alcova.jpg')", "#4682B4");
            criarPontoLocal([962, 444], "T√∫neis", "Passagem de volta para a superf√≠cie.", null, true, btnSubir);
            criarPontoLocal([772, 264], "T√∫neis", "Passagem de volta para a superf√≠cie.", null, true, btnSubir);
            criarPontoLocal([720, 948], "T√∫neis", "Passagem de volta para a superf√≠cie.", null, true, btnSubir);
            criarPontoLocal([834, 1404], "T√∫neis", "Passagem de volta para a superf√≠cie.", null, true, btnSubir);
            criarPontoLocal([1180, 1744], "T√∫neis", "Passagem de volta para a superf√≠cie.", null, true, btnSubir);
            
            criarPontoLocal( [1020, 954], "Cidade Submersa", "Desconhecido", "Cidade no mar.png", true);
            criarPontoLocal( [470, 538], "Cidade Submersa", "Desconhecido", "mais cidade no mar.png", true);
            criarPontoLocal( [982, 1826], "Cidade Submersa", "Desconhecido", "Cidade no mar 2.jpg", true);
            criarPontoLocal( [292, 1370], "Cidade Submersa", "Desconhecido");
        
        
        }
if (nomeDoMapa === 'Planos.jpg') {
        selecaoAtual = null; // Reseta sele√ß√£o

        // √çcone Gigante
        const iconMega = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', 
            iconSize: [120, 120], iconAnchor: [60, 120], popupAnchor: [0, -100]
        });

        // Fun√ß√£o Especial para o Nexus (Agora abre MAPAS e tem descri√ß√£o)
// Fun√ß√£o Especial para o Nexus (Atualizada para o novo estilo)
        function criarPontoNexus(coord, nome, descricao, chaveTexto, arquivoMapa) {
            const m = L.marker(coord, {icon: iconMega, opacity: 0}).addTo(map); 

            let botoes = "";
            if (arquivoMapa) {
                // Usamos a fun√ß√£o criarBtn para o fundo preto com barra roxa (#483D8B)
                botoes = criarBtn("üó∫Ô∏è Entrar no Plano", `abrirMapaProvincia('${arquivoMapa}')`, "#483D8B");
            }

            m.bindPopup(`<div style="text-align:center; width: 180px;"><b>${nome}</b><br><small style="color:#ccc;">${descricao}</small><div style="margin-top:10px;">${botoes}</div></div>`);

            m.on('click', function() { selecaoAtual = chaveTexto; });
        }

        // --- PONTOS DO NEXUS ---
        // Divino -> Abre o mapa "Plano Divino.png"
        criarPontoNexus([806, 214], "Plano Divino", "A morada da luz eterna.", "divino", "Plano Divino.png");
        criarPontoNexus([590, 214], "Plano Divino", "A morada da luz eterna.", "divino", "Plano Divino.png");

        // Demon√≠aco -> Abre o mapa "Plano Demon√≠aco.png"
        criarPontoNexus([254, 193], "Plano Demon√≠aco", "O abismo do caos.", "demoniaco", "Plano Demon√≠aco.png");
        criarPontoNexus([92, 202], "Plano Demon√≠aco", "O abismo do caos.", "demoniaco", "Plano Demon√≠aco.png");

        // Espiritual -> Abre o mapa "Plano Espiritual.png"
        criarPontoNexus([763, 544], "Plano Espiritual", "O fluxo de mana e almas.", "espiritual", "Plano Espiritual.png");
        criarPontoNexus([616, 556], "Plano Espiritual", "O fluxo de mana e almas.", "espiritual", "Plano Espiritual.png");

        // Mortal -> Volta pro Continente (Mantive o bot√£o verde diferente)
        const m = L.marker([246, 558], {icon: iconMega, opacity: 0}).addTo(map);
        
        const btnVoltar = criarBtn("üåç Voltar ao Continente", "carregarMapaPrincipal()", "#2E8B57");
       // const btnVoltar = `<button onclick="carregarMapaPrincipal()" class="btn-popup" style="background: #2E8B57; width: 100%;">üåç Voltar ao Continente</button>`;
        m.bindPopup(`<div style="text-align:center; width: 180px;"><b>Plano Mortal</b><br><small style="color:#ccc;">O mundo material de Arton.</small><div style="margin-top:10px;">${btnVoltar}</div></div>`);
        m.on('click', function() { selecaoAtual = 'mortal'; });
        
    }

    // --- 2. OS NOVOS MAPAS DOS PLANOS (Bot√£o para voltar ao Nexus) ---
    
    // Configura√ß√£o do bot√£o de voltar para o Nexus
    const btnVoltarNexus = `<button onclick="abrirMapaProvincia('Planos.jpg')" class="btn-popup" style="background: #aeb6bf; color: black;">‚Ü© Voltar ao Nexus</button>`;

    if (nomeDoMapa === 'Plano Divino.png') {
        // Coloquei num canto gen√©rico, ajuste a coordenada [Y, X] depois
        criarPontoLocal([100, 100], "Sa√≠da do Plano", "Portal de volta para a Grande Roda.", null, true, btnVoltarNexus);
        // Adicione aqui os pontos internos do Plano Divino...
    }

    if (nomeDoMapa === 'Plano Demon√≠aco.png') {
        criarPontoLocal([100, 100], "Sa√≠da do Abismo", "Portal de volta para a Grande Roda.", null, true, btnVoltarNexus);
        // Adicione aqui os pontos internos do Plano Demon√≠aco...
    }

    if (nomeDoMapa === 'Plano Espiritual.png') {
        criarPontoLocal([100, 100], "Sa√≠da do Fluxo", "Portal de volta para a Grande Roda.", null, true, btnVoltarNexus);
        // Adicione aqui os pontos internos do Plano Espiritual...
    }
    }

// --- 7. MARCADORES DO CONTINENTE ---
    function adicionarMarcadoresPrincipais() {
        const iconP = L.icon({iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [80, 80], iconAnchor: [40, 40], popupAnchor: [0, -40]});
        const iconG = L.icon({iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [120, 120], iconAnchor: [60, 60], popupAnchor: [0, -60]});

        function criarPonto(coord, nome, arg3, arg4, arg5) {
            let descricao = "", arquivo = "", tipo = "", grande = false;
            if (arg3 && (arg3.includes('.png') || arg3.includes('.jpg') || arg3.includes('.webp') || arg3 === null)) {
                arquivo = arg3; tipo = arg4; grande = arg5 || false;
            } else {
                descricao = arg3; arquivo = arg4; tipo = arg5;
            }

            const m = L.marker(coord, { icon: grande ? iconG : iconP, opacity: 0 }).addTo(map);
            let botoes = `<div style="margin-top:10px; display:flex; flex-direction:column;">`;

            // --- L√ìGICA ESPECIAL PARA A CAPITAL ---
            if (nome === "Capital Imperial") {
                botoes += criarBtn("‚öúÔ∏è <b>Her√≥is Lend√°rios</b>", "menuCapital('lendas')", "#DAA520");
                botoes += criarBtn("üè¶ Banco Imperial", "menuCapital('banco')", "#ffd700");
                botoes += criarBtn("üõ°Ô∏è Esquadr√£o", "menuCapital('esquadrao')", "#4682B4");
                botoes += criarBtn("üì∏ Ver Cidade", `verImagemEstatica('${arquivo}')`, "#5F9EA0");
                botoes += criarBtn("üìú Hist√≥rico", "menuCapital('historico')", "#9370DB");
                botoes += criarBtn("‚ò†Ô∏è Procurados", "menuCapital('procurados')", "#8b0000");
                botoes += criarBtn("üó£Ô∏è Boatos", "menuCapital('boatos')", "#800080");
                botoes += criarBtn("üìñ Besti√°rio", "menuCapital('bestiario')", "#2E8B57");
            } 
            // --- CIDADE SAGRADA ---
            else if (nome === "Cidade Sagrada") {
                if (arquivo) botoes += criarBtn("üì∏ Ver Cidade", `verImagemEstatica('${arquivo}')`, "#5F9EA0");
                botoes += criarBtn("‚ö° Pante√£o", "menuDeuses()", "#4682B4");
            }
            // --- TORRE DOS S√ÅBIOS ---
            else if (nome === "Torre dos S√°bios") {
                if (arquivo) botoes += criarBtn("üì∏ Ver Exterior", `verImagemEstatica('${arquivo}')`, "#5F9EA0");
                botoes += criarBtn("üîÆ Acessar Interior", `abrirModalSenha('fofoca', 'bloqueado.jpg', 'imagem')`, "#9370DB");
            }
            else if (nome === "Ilha Paradis√≠aca") {
    if (arquivo) botoes += criarBtn("üì∏ Ver Ilha", `verImagemEstatica('${arquivo}')`, "#5F9EA0");
    // Adicionando a Importa√ß√£o com o estilo novo
    botoes += criarBtn("üì¶ Importa√ß√£o", "verImagemEstatica('bloqueado.jpg')", "#FF8C00");
}
            // --- PONTOS GEN√âRICOS (VILAREJOS / PROV√çNCIAS) ---
            else {
                if (arquivo) {
                    if (tipo === 'mapa') botoes += criarBtn("üó∫Ô∏è Explorar Prov√≠ncia", `abrirMapaProvincia('${arquivo}')`, "#8b4513");
                    else if (tipo === 'imagem') botoes += criarBtn("üì∏ Ver Foto", `verImagemEstatica('${arquivo}')`, "#5F9EA0");
                }
                
                if (nome === "P√¢ntano" || nome === "Floresta dos Sonhos") {
                    let senha = (nome === "P√¢ntano") ? "Seita" : "perdido";
                    botoes += criarBtn("üîç Descobrir", `abrirModalSenha('${senha}', 'bloqueado.jpg', 'imagem')`, "#2E8B57");
                }
            }

            botoes += `</div>`;
            m.bindPopup(`<div style="text-align:center;"><b>${nome}</b><br><small style="color:#ccc;">${descricao}</small>${botoes}</div>`);
        }

// PONTOS
        criarPonto([824, 2330], "Deserto","A Origem do Mundo", "Deserto.jpg", 'mapa');
        criarPonto([3850, 3580], "Hukmal'tep", "O Inverno Absoluto","Hukmal_tep.jpg", 'mapa');
        criarPonto([2902, 5464], "Blat'khyr", "O Ber√ßo da Magia", "Blat_khyr.jpg", 'mapa');
        criarPonto([1118, 4346], "Lago", "O Solo Aben√ßoado", "Lago.jpg", 'mapa');
        criarPonto([1356, 3284], "Alcova","O Lar dos Piratas", "Alcova.jpg", 'mapa');
        criarPonto([2250, 4258], "Espinha do Gigante", "As Terras Altas", "Espinha do Gigante.jpg", 'mapa', true);
        criarPonto([2142, 4378], "Espinha do Gigante","As Terras Altas", "Espinha do Gigante.jpg", 'mapa', true);
        
        criarPonto([2370, 3767], "Capital Imperial", "A Casa do Imp√©rio", "Capital.png", 'imagem');
        criarPonto([1648, 4438], "Cidade Sagrada", "Cidade Santa.png", 'imagem');
        criarPonto([2862, 2890], "Torre dos S√°bios", "Torre dos Sabios.png", 'imagem');
        criarPonto([1188, 5574], "Ilha Paradis√≠aca", "ilha 2.png", 'imagem');
        
        criarPonto([1830, 2322], "Vilarejo", "cidade da ra√ßa l√°.png", 'imagem');
        criarPonto([2114, 3854], "Vilarejo", "vilarejo.png", 'imagem');
        criarPonto([2142, 3254], "Vilarejo", "vilarejo 2.jpg", 'imagem');
        criarPonto([1758, 4620], "Vilarejo", "vilarejo 3.jpg", 'imagem');
        
        criarPonto([2252, 2880], "P√¢ntano", "pantano.png", 'imagem');
        criarPonto([2138, 2890], "P√¢ntano", "pantano.png", 'imagem');
        criarPonto([2228, 3032], "P√¢ntano", "pantano.png", 'imagem');
        criarPonto([2220, 2656], "P√¢ntano", "pantano.png", 'imagem');
        
        criarPonto([2232, 3936], "Vilarejo", "Sem detalhes", 'none');
        criarPonto([2300, 3400], "Vilarejo", "Sem detalhes", 'none');
        criarPonto([1830, 4354], "Vilarejo", "Sem detalhes", 'none');
        criarPonto([1630, 3054], "Vilarejo", "Sem detalhes", 'none');
        criarPonto([2464, 4974], "Ilha de Blat'khyr", "Cad√™?", "Ilha.png", 'imagem');
        
        criarPonto([1838, 3526], "Floresta dos Sonhos", "floresta dos sonhos.png", 'imagem');
        criarPonto([1750, 3320], "Floresta dos Sonhos", "floresta dos sonhos.png", 'imagem');
        criarPonto([1536, 3634], "Floresta dos Sonhos", "floresta dos sonhos.png", 'imagem');
        criarPonto([2070, 3642], "Floresta dos Sonhos", "floresta dos sonhos.png", 'imagem');
        
        criarPonto([3912, 1780], "Inverno Desolado", "O inverno est√° chegando...", 'none', true);
    }
    


    // Fun√ß√£o para controlar os bot√µes (Menu e Mapa)
    function atualizarBotaoMedidor(estado) {
        const btnMenu = document.getElementById('btn-medidor');
        const btnMapa = document.getElementById('btn-medidor-mapa');
        
        let texto, cor, corTexto;

        if (estado === 'iniciar') { // Estado Neutro
            texto = "üìè Calculadora de Viagem";
            cor = ""; // Padr√£o
            corTexto = "#90EE90";
        } 
        else if (estado === 'medindo') { // Estado Ativo
            texto = "üèÅ Finalizar Rota"; // Clica aqui para calcular
            cor = "#2E8B57"; // Verde
            corTexto = "white";
        }

        if (btnMenu) {
            btnMenu.innerHTML = texto;
            btnMenu.style.background = cor;
            btnMenu.style.color = corTexto;
        }
        if (btnMapa) {
            btnMapa.innerHTML = estado === 'iniciar' ? "üìè Medir" : "üèÅ Calcular";
            btnMapa.style.background = cor || "rgba(0,0,0,0.8)";
            btnMapa.style.color = corTexto;
        }
    }

    function ativarMedidor() {
        if (!medindo) {
            // --- INICIAR MEDI√á√ÉO ---
            medindo = true;
            pontosRota = []; // Zera a mem√≥ria da rota
            grupoRota.addTo(map); // Adiciona o grupo ao mapa
            grupoRota.clearLayers(); // Limpa desenhos anteriores (AQUI RESOLVE A PERSIST√äNCIA)
            
            // Ativa o "Modo Fantasma" (CSS) para clicar atrav√©s das cidades
            document.getElementById('map-container').classList.add('mapa-intangivel');
            document.getElementById('map').classList.add('modo-medicao-ativo');
            
            atualizarBotaoMedidor('medindo');
            
        } else {
            // --- FINALIZAR E CALCULAR ---
            // S√≥ calcula se tiver pelo menos uma linha (2 pontos)
            if (pontosRota.length > 1) {
                calcularResultados();
            } else {
                // Se clicou em finalizar sem marcar nada, s√≥ cancela
                cancelarModoMedicao();
            }
        }
    }

    // Sai do modo de medi√ß√£o e devolve os cliques para as cidades
    function cancelarModoMedicao() {
        medindo = false;
        document.getElementById('map-container').classList.remove('mapa-intangivel');
        document.getElementById('map').classList.remove('modo-medicao-ativo');
        atualizarBotaoMedidor('iniciar');
    }

    // Processa cada clique no mapa
    function processarCliqueMedicao(latlng) {
        // Adiciona coordenada √† lista
        pontosRota.push(latlng);

        // Desenha uma bolinha (ponto)
        const bolinha = L.circleMarker(latlng, {
            radius: 4, color: 'white', fillColor: '#ff4444', fillOpacity: 1, className: 'marcador-rota'
        }).addTo(grupoRota);

        // Se tiver mais de 1 ponto, desenha a linha conectando o anterior ao atual
        if (pontosRota.length > 1) {
            const ultimoPonto = pontosRota[pontosRota.length - 2];
            const linha = L.polyline([ultimoPonto, latlng], {
                color: '#ff4444', weight: 3, dashArray: '5, 10'
            }).addTo(grupoRota);
        }
    }

function calcularResultados() {
        let distanciaTotalPixels = 0;

        // Soma a dist√¢ncia de todos os segmentos da rota
        for (let i = 0; i < pontosRota.length - 1; i++) {
            distanciaTotalPixels += map.distance(pontosRota[i], pontosRota[i+1]);
        }

        // --- C√ÅLCULOS ---
        const distanciaReal = distanciaTotalPixels * fatorEscala;

        // CALIBRA√á√ÉO DE TEMPO (CORRIGIDA)
        // Usamos 30 km por dia (ritmo de marcha padr√£o de RPG)
        // Antes estava 150 (que era baseado em pixels, por isso estava r√°pido demais)
        const kmPorDiaPe = 30; 
        
        const diasPe = (distanciaReal / kmPorDiaPe).toFixed(1);
        const diasMontariaLenta = (distanciaReal / (kmPorDiaPe * 1.5)).toFixed(1); // Mula
        const diasMontariaNormal = (distanciaReal / (kmPorDiaPe * 2.0)).toFixed(1); // Cavalo
        const diasMontariaRapida = (distanciaReal / (kmPorDiaPe * 4.0)).toFixed(1); // Voo

        // --- ECONOMIA (CORRIGIDA - METADE DO PRE√áO) ---
        // 1 Gold = 100 Prata = 10000 Bronze
        
        // Taxa de Embarque: 2.5 Golds (Era 5)
        const custoBase = 25000; 
        
        // Custo por KM: 2.5 Pratas (Era 5)
        const custoPorKm = 250;  
        
        let custoTotalCobre = Math.floor(custoBase + (distanciaReal * custoPorKm));

        // Convers√£o de Moedas
        const golds = Math.floor(custoTotalCobre / 10000);
        custoTotalCobre %= 10000;
        const silvers = Math.floor(custoTotalCobre / 100);
        const bronzes = custoTotalCobre % 100;

        // Monta o HTML do Resultado
        let html = `
            <p><strong>Rota Total:</strong> ${Math.floor(distanciaReal)} km (aprox).</p>
            <table class="tabela-viagem">
                <tr><th>M√©todo</th><th>Tempo Total</th></tr>
                <tr><td>üö∂ A P√©</td><td>${diasPe} dias</td></tr>
                <tr><td>üê¥ Mula/Burro (Montaria Lenta)</td><td>${diasMontariaLenta} dias</td></tr>
                <tr><td>üêé Cavalo (Montaria Normal)</td><td>${diasMontariaNormal} dias</td></tr>
                <tr><td>‚ö° Montaria Especial (Montaria R√°pida)</td><td>${diasMontariaRapida} dias</td></tr>
            </table>

            <hr>
            <h4 style="color: #87CEEB;">üîÆ Transporte Imperial Seguro</h4>
            <p>Taxa de risco e seguro inclusos.</p>
            <p><strong>Valor Total:</strong><br>
            <span class="destaque-gold">${golds} Ouro</span>, 
            <span class="destaque-silver">${silvers} Prata</span>, 
            <span class="destaque-bronze">${bronzes} Bronze</span>.
            </p>
        `;

        document.getElementById('resultado-viagem').innerHTML = html;
        document.getElementById('modal-viagem').style.display = 'flex';
        
        // Sai do modo de medi√ß√£o, mas MANT√âM O DESENHO na tela para verem
        cancelarModoMedicao();
    }
    function desfazerUltimoPonto() {
        if (pontosRota.length > 0) {
            // Remove a √∫ltima coordenada da mem√≥ria
            pontosRota.pop();
            
            // Remove o √∫ltimo desenho (bolinha ou linha)
            // O Leaflet adiciona camadas em ordem, ent√£o remover a √∫ltima funciona visualmente
            const camadas = grupoRota.getLayers();
            if (camadas.length > 0) {
                grupoRota.removeLayer(camadas[camadas.length - 1]); // Remove a bolinha
                if (camadas.length > 1) { // Se tinha linha ligando, remove ela tamb√©m
                     grupoRota.removeLayer(camadas[camadas.length - 2]); 
                }
            }
        }
    }
    // Inicializa√ß√£o
    carregarMapaPrincipal();
    </script>
</body>
</html>